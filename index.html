<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>오늘의 회화 영단어</title>
  <style>
    :root{
      --blue:#1e5ef3; --blue2:#1a4fd1; --bg:#f6f7fb; --card:#fff;
      --text:#111; --muted:#667085; --green:#1fb86a; --red:#e74c3c;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    /* Header */
    .appbar{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff;padding:16px 20px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;font-size:20px;letter-spacing:-.2px;white-space:nowrap}
    .spacer{flex:1}
    .icon-btn{width:44px;height:44px;border-radius:999px;display:grid;place-items:center;background:rgba(255,255,255,.15);border:none;color:#fff}
    .icon-btn:active{transform:scale(.98)}
    /* Toolbar (날짜/재생/기타) */
    .toolbar{max-width:980px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .btn{height:44px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;padding:0 14px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.green{background:var(--green);color:#fff;border-color:var(--green)}
    .btn.red{background:var(--red);color:#fff;border-color:var(--red)}
    .btn.ghost{background:#fff}
    .btn:active{transform:translateY(1px)}
    .date-wrap{grid-column:span 6;display:flex;gap:8px}
    .date-box{flex:1;min-width:0;height:44px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.2px;padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .date-nav{width:44px}
    .row{grid-column:span 12;display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{min-width:120px}
    /* 메인 리스트 */
    .container{max-width:980px;margin:8px auto 80px;padding:0 16px}
    .hint{color:var(--muted);margin:12px 0}
    /* 계정 슬라이드 */
    .drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.2s;z-index:80}
    .drawer{position:fixed;top:0;right:-420px;width:420px;max-width:92vw;height:100vh;background:#fff;border-radius:16px 0 0 16px;box-shadow:-16px 0 40px rgba(0,0,0,.18);transition:.25s;z-index:90;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer-backdrop.show{opacity:1;pointer-events:auto}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #eef0f3}
    .drawer-title{font-weight:800;font-size:22px}
    .xbtn{width:40px;height:40px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .drawer-body{padding:18px 20px;overflow:auto}
    .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .field label{font-weight:700}
    .input{height:44px;border:1px solid #e5e7eb;border-radius:12px;padding:0 12px;font-size:16px;background:#fff}
    .row2{display:flex;gap:10px}
    .full{width:100%}
    .google{background:#fff;border:1px solid #e5e7eb}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;background:#f1f5ff;color:#1743e6;font-weight:800;padding:8px 12px}
    .card{background:#fff;border:1px solid #eef0f3;border-radius:14px;padding:14px}
    .danger{background:#fff1f0;border-color:#ffd6d3;color:#b42318}
    @media (max-width:520px){
      .title{font-size:18px}
      .row .btn{min-width:108px}
      .date-wrap{grid-column:span 12}
    }
  </style>
</head>
<body>

  <!-- 헤더 -->
  <header class="appbar">
    <div class="title">오늘의 회화 영단어</div>
    <div class="spacer"></div>
    <button id="accountBtn" class="icon-btn" aria-label="계정">
      <!-- 점 세 개 아이콘 -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="5" cy="12" r="2"></circle>
        <circle cx="12" cy="12" r="2"></circle>
        <circle cx="19" cy="12" r="2"></circle>
      </svg>
    </button>
  </header>

  <!-- 툴바 -->
  <section class="toolbar" aria-label="도구">
    <div class="date-wrap">
      <button id="prevDate" class="btn date-nav" aria-label="이전 날짜">◀</button>
      <div id="dateText" class="date-box">YYYY-MM-DD</div>
      <button id="nextDate" class="btn date-nav" aria-label="다음 날짜">▶</button>
    </div>

    <div class="row">
      <button id="playAll" class="btn">전체 재생</button>
      <button id="stopAll" class="btn">정지</button>
      <button id="markDone" class="btn green">오늘분 완료</button>
      <button id="todayBtn" class="btn ghost">오늘의 단어</button>
      <button id="favBtn" class="btn ghost">★ 어려운 단어</button>
      <button id="logBtn" class="btn ghost">기록</button>
      <button id="logDelBtn" class="btn red">기록 삭제</button>
    </div>
  </section>

  <!-- 메인 -->
  <main class="container">
    <p class="hint">여기에 단어 리스트 / 날짜 선택 등이 들어갑니다…</p>
    <div id="list"></div>
  </main>

  <!-- 계정 드로어 -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="accountDrawer" class="drawer" aria-label="계정">
    <div class="drawer-head">
      <div class="drawer-title">계정</div>
      <button id="drawerClose" class="xbtn" aria-label="닫기">✕</button>
    </div>
    <div class="drawer-body" id="drawerBody">

      <!-- 로그인 전 -->
      <div id="loginView" style="display:none">
        <div class="pill" style="margin-bottom:10px">로그인</div>
        <div class="field">
          <label for="loginEmail">이메일</label>
          <input id="loginEmail" class="input" type="email" placeholder="you@example.com" autocomplete="username">
        </div>
        <div class="field">
          <label for="loginPw">비밀번호</label>
          <input id="loginPw" class="input" type="password" placeholder="8자리 이상" autocomplete="current-password">
        </div>
        <div class="row2" style="margin-top:8px">
          <button id="loginBtn" class="btn full">로그인</button>
          <button id="openSignup" class="btn full">회원가입</button>
        </div>

        <div style="height:14px"></div>
        <button id="googleBtn" class="btn google full" aria-label="Google로 로그인">
          <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 31.7 29.3 35 24 35c-6.1 0-11-4.9-11-11s4.9-11 11-11c2.8 0 5.4 1.1 7.4 2.9l5.7-5.7C33.6 7 28.9 5 24 5 13 5 4 14 4 25s9 20 20 20c11.5 0 19.3-8.1 19.3-19.5 0-1.3-.1-2.1-.7-3z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.9 16.1 19.1 13 24 13c2.8 0 5.4 1.1 7.4 2.9l5.7-5.7C33.6 7 28.9 5 24 5 15.5 5 8.2 9.9 6.3 14.7z"/><path fill="#4CAF50" d="M24 45c5.2 0 10-1.8 13.7-5l-6.3-5.2C29.3 35 26.8 36 24 36c-5.3 0-9.7-3.4-11.4-8.1l-6.5 5.1C8.1 40.1 15.5 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.7-5.3 7-11.3 7-6.1 0-11-4.9-11-11s4.9-11 11-11c2.8 0 5.4 1.1 7.4 2.9l5.7-5.7C33.6 7 28.9 5 24 5 13 5 4 14 4 25s9 20 20 20c11.5 0 19.3-8.1 19.3-19.5 0-1.3-.1-2.1-.7-3z"/></svg>
          Google로 로그인
        </button>
      </div>

      <!-- 회원가입 -->
      <div id="signupView" style="display:none">
        <div class="pill" style="margin-bottom:10px">회원가입</div>
        <div class="field">
          <label for="sgId">아이디(선택·문서속성)</label>
          <input id="sgId" class="input" placeholder="예: rlagusdn6763">
        </div>
        <div class="field">
          <label for="sgNick">닉네임</label>
          <input id="sgNick" class="input" placeholder="닉네임 입력">
        </div>
        <div class="field">
          <label for="sgEmail">이메일</label>
          <input id="sgEmail" class="input" type="email" placeholder="you@example.com" autocomplete="username">
        </div>
        <div class="row2">
          <div class="field full">
            <label for="sgPw1">비밀번호</label>
            <input id="sgPw1" class="input" type="password" placeholder="8자리 이상" autocomplete="new-password">
          </div>
          <div class="field full">
            <label for="sgPw2">비밀번호 확인</label>
            <input id="sgPw2" class="input" type="password" placeholder="다시 입력" autocomplete="new-password">
          </div>
        </div>
        <div class="row2" style="margin-top:8px">
          <button id="doSignup" class="btn full">회원가입 완료</button>
          <button id="backToLogin" class="btn full">로그인으로</button>
        </div>
      </div>

      <!-- 로그인 후 -->
      <div id="profileView" style="display:none">
        <div class="pill" style="margin-bottom:10px">로그인됨</div>

        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:700;margin-bottom:6px">이메일</div>
          <div id="pfEmail" style="font-weight:800"></div>
        </div>

        <div class="card" style="margin-bottom:16px">
          <div style="font-weight:700;margin-bottom:6px">닉네임</div>
          <div id="pfNick" style="font-weight:800"></div>
        </div>

        <div class="row2">
          <button id="logoutBtn" class="btn red full">로그아웃</button>
        </div>

        <div class="card danger" style="margin-top:14px">
          저장된 닉네임을 바꾸고 싶다면 Firestore <b>users/{uid}</b> 문서의 <b>nickname</b>을 수정하세요.
        </div>
      </div>

    </div>
  </aside>

  <!-- Firebase & App -->
  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // 너의 프로젝트 키 (동일)
    const firebaseConfig = {
      apiKey: "AIzaSyBtN9HptAjl3wzemzKIr8nHvRHyOsvjsNI",
      authDomain: "voca-khw.firebaseapp.com",
      projectId: "voca-khw",
      storageBucket: "voca-khw.firebasestorage.app",
      messagingSenderId: "697341566223",
      appId: "1:697341566223:web:2a40f413b1edeb543c727a",
      measurementId: "G-Y5XZEX3W9X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // users/{uid} 업서트
    async function upsertUserProfile(user, extra = {}) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          email: user.email ?? "",
          nickname: extra.nickname ?? "",
          customId: extra.customId ?? "",
          createdAt: new Date().toISOString()
        });
      } else if (extra && Object.keys(extra).length) {
        await setDoc(ref, { ...snap.data(), ...extra }, { merge: true });
      }
      return (await getDoc(ref)).data();
    }

    /* --------------- UI 엘리먼트 --------------- */
    const accountBtn = document.getElementById('accountBtn');
    const drawer     = document.getElementById('accountDrawer');
    const backdrop   = document.getElementById('drawerBackdrop');
    const xbtn       = document.getElementById('drawerClose');

    const loginView  = document.getElementById('loginView');
    const signupView = document.getElementById('signupView');
    const profileView= document.getElementById('profileView');

    const loginEmail = document.getElementById('loginEmail');
    const loginPw    = document.getElementById('loginPw');
    const loginBtn   = document.getElementById('loginBtn');
    const openSignup = document.getElementById('openSignup');

    const sgId   = document.getElementById('sgId');
    const sgNick = document.getElementById('sgNick');
    const sgEmail= document.getElementById('sgEmail');
    const sgPw1  = document.getElementById('sgPw1');
    const sgPw2  = document.getElementById('sgPw2');
    const doSignup   = document.getElementById('doSignup');
    const backToLogin= document.getElementById('backToLogin');

    const googleBtn = document.getElementById('googleBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const pfEmail   = document.getElementById('pfEmail');
    const pfNick    = document.getElementById('pfNick');

    const dateText  = document.getElementById('dateText');
    const prevDate  = document.getElementById('prevDate');
    const nextDate  = document.getElementById('nextDate');
    const todayBtn  = document.getElementById('todayBtn');
    const playAll   = document.getElementById('playAll');
    const stopAll   = document.getElementById('stopAll');
    const markDone  = document.getElementById('markDone');
    const favBtn    = document.getElementById('favBtn');
    const logBtn    = document.getElementById('logBtn');
    const logDelBtn = document.getElementById('logDelBtn');

    // 드로어 열기/닫기
    const openDrawer  = ()=>{ drawer.classList.add('open'); backdrop.classList.add('show') };
    const closeDrawer = ()=>{ drawer.classList.remove('open'); backdrop.classList.remove('show') };

    accountBtn.addEventListener('click', openDrawer);
    xbtn.addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);

    // 뷰 스위치
    function showLogin(){ loginView.style.display='block'; signupView.style.display='none'; profileView.style.display='none' }
    function showSignup(){ loginView.style.display='none'; signupView.style.display='block'; profileView.style.display='none' }
    function showProfile(){ loginView.style.display='none'; signupView.style.display='none'; profileView.style.display='block' }

    openSignup.addEventListener('click', showSignup);
    backToLogin.addEventListener('click', showLogin);

    // 로그인
    loginBtn.addEventListener('click', async ()=>{
      try{
        const email = loginEmail.value.trim();
        const pw    = loginPw.value.trim();
        if(!email || !pw) return alert('이메일/비밀번호를 입력하세요.');
        await signInWithEmailAndPassword(auth, email, pw);
        // onAuthStateChanged가 UI 업데이트
      }catch(err){
        alert(`로그인 실패: ${err.message}`);
      }
    });

    // 구글 로그인
    googleBtn.addEventListener('click', async ()=>{
      try{
        const cred = await signInWithPopup(auth, provider);
        await upsertUserProfile(cred.user); // 최초 로그인 시 프로필 생성
      }catch(err){
        alert(`Google 로그인 실패: ${err.message}`);
      }
    });

    // 회원가입
    doSignup.addEventListener('click', async ()=>{
      try{
        const id    = sgId.value.trim();
        const nick  = sgNick.value.trim();
        const email = sgEmail.value.trim();
        const pw1   = sgPw1.value.trim();
        const pw2   = sgPw2.value.trim();
        if(!nick)  return alert('닉네임을 입력하세요.');
        if(!email) return alert('이메일을 입력하세요.');
        if(pw1.length<8) return alert('비밀번호는 8자리 이상이어야 합니다.');
        if(pw1!==pw2)   return alert('비밀번호가 일치하지 않습니다.');

        const cred = await createUserWithEmailAndPassword(auth, email, pw1);
        await upsertUserProfile(cred.user, { nickname:nick, customId:id });
        alert('회원가입 완료!');
      }catch(err){
        alert(`회원가입 실패: ${err.message}`);
      }
    });

    // 로그아웃
    logoutBtn.addEventListener('click', async ()=>{
      try{
        await signOut(auth);
        alert('로그아웃 되었습니다.');
        showLogin();
      }catch(err){
        alert(`로그아웃 실패: ${err.message}`);
      }
    });

    // 상태 변경 -> 프로필 표시
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        try{
          const ref = doc(db,'users',user.uid);
          const snap= await getDoc(ref);
          const data= snap.exists()? snap.data(): null;
          pfEmail.textContent = user.email || '-';
          pfNick.textContent  = data?.nickname || '(닉네임 미입력)';
          showProfile();
        }catch(e){
          pfEmail.textContent = user.email || '-';
          pfNick.textContent  = '(프로필 조회 실패)';
          showProfile();
        }
      }else{
        showLogin();
      }
    });

    /* ----------- 날짜/버튼(기존 동작 유지용 최소 구현) ----------- */
    function fmt(d){return d.toISOString().slice(0,10)}
    let cur = new Date();
    function setDate(d){ dateText.textContent = fmt(d) }
    setDate(cur);

    prevDate.addEventListener('click', ()=>{ cur.setDate(cur.getDate()-1); setDate(cur); });
    nextDate.addEventListener('click', ()=>{ cur.setDate(cur.getDate()+1); setDate(cur); });
    todayBtn.addEventListener('click', ()=>{ cur=new Date(); setDate(cur); });

    // 아래 3개 핸들러는 기존 로직과 연결해서 사용하세요.
    playAll.addEventListener('click', ()=>{/* 전체 재생 로직 호출 */});
    stopAll.addEventListener('click', ()=>{/* 정지 로직 호출 */});
    markDone.addEventListener('click', ()=>{/* 완료 처리 + 기록 로직 호출 */});

    /* ▼▼▼ 여기 아래에 '기존 단어 학습 기능 스크립트'를 그대로 붙여 넣으세요 ▼▼▼
       - words.json 로딩 및 렌더링
       - 음성 재생(영/한 TTS)
       - 즐겨찾기(어려운 단어) / 기록 / 기록삭제
       - 날짜별 로딩/완료 처리 등
    */
  </script>
</body>
</html>
