<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오늘의 회화 영단어</title>
  <style>
    :root{
      --blue:#1e63e9; --blue-dark:#134bb7; --green:#1fb86a; --red:#e84a4a;
      --bg:#f5f7fb; --card:#fff; --text:#111; --muted:#667085; --ring:rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .app{max-width:980px;margin:0 auto;padding-bottom:64px}
    /* 헤더 */
    .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(90deg,var(--blue),var(--blue-dark));color:#fff}
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px}
    .title{font-weight:800;letter-spacing:.3px}
    .title span{display:inline-block;transform:translateY(1px)}
    .account-toggle{
      width:42px;height:42px;border-radius:999px;background:rgba(255,255,255,.16);
      border:none;color:#fff;font-size:22px;cursor:pointer;display:grid;place-items:center;
      transition:.2s;
    }
    .account-toggle:hover{background:rgba(255,255,255,.24)}

    /* 날짜줄 */
    .date-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;padding:12px 16px}
    .nav-btn{width:52px;height:48px;border-radius:12px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:18px}
    .date-pill{
      display:flex;align-items:center;justify-content:center;height:48px;padding:0 16px;border-radius:12px;background:#fff;border:1px solid var(--ring);
      font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-size:clamp(14px,4.2vw,20px); /* 한 줄 유지 */
    }
    .today-btn{height:48px;padding:0 14px;border-radius:12px;border:1px solid var(--ring);background:#fff;cursor:pointer}

    /* 컨트롤 */
    .controls{display:flex;flex-wrap:wrap;gap:10px;padding:0 16px}
    .btn{height:46px;padding:0 16px;border-radius:999px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-weight:700}
    .btn-green{background:var(--green);color:#fff;border-color:transparent}
    .btn-red{background:var(--red);color:#fff;border-color:transparent}
    .chip{height:42px;border-radius:999px;padding:0 14px;border:1px solid var(--ring);background:#fff}

    /* 옵션 */
    .options{display:flex;align-items:center;gap:12px;padding:10px 16px}
    .range{flex:1}
    .select{min-width:180px;height:42px;border-radius:10px;border:1px solid var(--ring);background:#fff;padding:0 10px}

    /* 카드 */
    .list{display:flex;flex-direction:column;gap:12px;padding:12px 16px}
    .card{
      background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);padding:14px;
      display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start;
    }
    .idx{width:32px;height:32px;border-radius:999px;background:#eef3ff;color:#1d4ed8;display:grid;place-items:center;font-weight:800}
    .word{font-size:20px;font-weight:900;margin:0 0 6px}
    .mean{margin:0 0 6px;color:var(--muted)}
    .ex{margin:0;color:#334155}
    .pill{height:36px;padding:0 10px;border-radius:10px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-weight:700}
    .star{width:36px;height:36px;border-radius:10px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:18px}
    .star.active{color:#f59e0b;background:#fff7e6;border-color:#ffd38a}

    /* 계정 슬라이드 */
    .panel{
      position:fixed;top:0;right:-340px;width:320px;height:100dvh;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,.12);
      transition:right .28s ease;z-index:50;padding:18px 16px;overflow:auto;
    }
    .panel.open{right:0}
    .panel h2{margin:6px 0 14px}
    .panel input{width:100%;height:44px;border:1px solid var(--ring);border-radius:10px;padding:0 12px;margin:6px 0}
    .panel .wbtn{width:100%;height:44px;border-radius:10px;border:1px solid var(--ring);background:#fff;margin:6px 0;font-weight:800}
    .google{background:#4285F4;color:#fff;border-color:#4285F4}

    /* 기록/삭제 모드 */
    .records-wrap{padding:8px 16px}
    .record-row{
      display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--ring);border-radius:12px;padding:12px;margin-bottom:8px
    }
    .record-row input{width:20px;height:20px}

    @media (max-width:560px){
      .controls{justify-content:center}
      .options{flex-wrap:wrap}
      .select{min-width:140px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner app">
      <div class="title"><span>오늘의 회화 영단어</span></div>
      <button id="openAccount" class="account-toggle" aria-label="계정">●</button>
    </div>
  </div>

  <div class="app">
    <!-- 날짜줄 -->
    <div class="date-row">
      <button id="prevDay" class="nav-btn" aria-label="이전">◀</button>
      <div id="dateText" class="date-pill">YYYY-MM-DD</div>
      <button id="nextDay" class="nav-btn" aria-label="다음">▶</button>
      <button id="gotoToday" class="today-btn">오늘의 단어</button>
    </div>

    <!-- 컨트롤 -->
    <div class="controls">
      <button id="playAll" class="btn">전체 재생</button>
      <button id="stopAll" class="btn">정지</button>
      <button id="doneBtn" class="btn btn-green">오늘분 완료</button>
      <button id="hardBtn" class="chip">★ 어려운 단어</button>
      <button id="recBtn" class="chip">기록</button>
      <button id="recDelBtn" class="btn btn-red">기록 삭제</button>
    </div>

    <!-- 옵션 -->
    <div class="options">
      <div>속도</div>
      <input id="speed" type="range" min="0.6" max="1.6" value="1" step="0.1" class="range" />
      <select id="enVoice" class="select"></select>
    </div>

    <!-- 단어 리스트 -->
    <div id="list" class="list" role="list"></div>

    <!-- 기록/삭제 UI (동적으로 표시) -->
    <div id="recordsWrap" class="records-wrap" style="display:none"></div>
  </div>

  <!-- 계정 패널 -->
  <aside id="panel" class="panel" aria-label="계정 패널">
    <h2>계정</h2>
    <div id="authBox">
      <input type="email" id="email" placeholder="you@example.com" />
      <input type="password" id="pass" placeholder="8자리 이상" />
      <button id="login" class="wbtn">로그인</button>
      <button id="signup" class="wbtn">회원가입</button>
      <button id="gLogin" class="wbtn google">Google로 로그인</button>
    </div>
    <div id="userBox" style="display:none">
      <div id="userBadge" style="display:flex;align-items:center;gap:10px;background:#f2f4ff;border:1px solid #dfe4ff;padding:10px;border-radius:12px;margin-bottom:10px">
        <div id="userInitial" style="width:36px;height:36px;border-radius:999px;background:#3b5bfd;color:#fff;display:grid;place-items:center;font-weight:900"></div>
        <div>
          <div id="userName" style="font-weight:800"></div>
          <div id="userEmail" style="color:#6b7280"></div>
        </div>
      </div>
      <button id="logout" class="wbtn">로그아웃</button>
    </div>
  </aside>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script>
    /*************** Firebase 초기화 ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyBtN9HptAjl3wzemzKIr8nHvRHyOsvjsNI",
      authDomain: "voca-khw.firebaseapp.com",
      projectId: "voca-khw",
      storageBucket: "voca-khw.appspot.com",
      messagingSenderId: "697341566223",
      appId: "1:697341566223:web:2a40f413b1edeb543c727a",
      measurementId: "G-Y5XZEX3W9X"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const analytics = firebase.analytics();

    /*************** 상태 & 저장소 ***************/
    const $ = s => document.querySelector(s);
    const dateText = $('#dateText');
    const listEl = $('#list');
    const recordsWrap = $('#recordsWrap');
    let currentDate = new Date();
    let pool = [];
    let currentWords = [];
    let playing = false;
    let playQueue = [];
    const LS = {
      key(k){ return 'voca_'+k; },
      get(k,def){ try{ const v = localStorage.getItem(this.key(k)); return v?JSON.parse(v):def; }catch(e){ return def; } },
      set(k,v){ localStorage.setItem(this.key(k), JSON.stringify(v)); }
    };

    const userScope = () => {
      const u = auth.currentUser?.uid || 'guest';
      return {
        recKey: `records_${u}`,
        hardKey: `hard_${u}`,
        cfgKey: `cfg_${u}`
      }
    };

    /*************** Util ***************/
    const fmtDate = d => {
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };
    const dateFromStr = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };

    // Seeded random (Mulberry32)
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
    function pickByDate(dateStr, count=10){
      if(!pool.length) return [];
      let seed = 0; for(const c of dateStr) seed = ((seed<<5)-seed)+c.charCodeAt(0) & 0xffffffff;
      const rnd = mulberry32(seed);
      const used = new Set(); const res=[];
      while(res.length<count && used.size<pool.length){
        const idx = Math.floor(rnd()*pool.length);
        if(!used.has(idx)){ used.add(idx); res.push(pool[idx]); }
      }
      return res;
    }

    function toast(msg){ alert(msg); }

    /*************** 음성 ***************/
    let voices=[];
    function loadVoices(){
      voices = speechSynthesis.getVoices();
      const enSel = $('#enVoice');
      enSel.innerHTML='';
      // 영어 보이스만 노출
      const ens = voices.filter(v=>/^en(-|_)/i.test(v.lang));
      ens.forEach((v,i)=>{
        const o=document.createElement('option');
        o.value=v.name; o.textContent=`${v.name} (${v.lang})`;
        enSel.appendChild(o);
      });
      // 저장된 보이스
      const cfg=LS.get(userScope().cfgKey,{speed:1,enVoice:ens[0]?.name||''});
      if(cfg.enVoice){
        enSel.value = cfg.enVoice;
      }
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    function speak(text, lang, rate, voiceName){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = rate;
      if(voiceName){
        const v = voices.find(v=>v.name===voiceName);
        if(v) u.voice = v;
      }else{
        // 한국어는 ko-KR 보이스 자동 선택
        const v = voices.find(v=>/^ko(-|_)/i.test(v.lang));
        if(v) u.voice=v;
      }
      return new Promise(res=>{
        u.onend=()=>res();
        speechSynthesis.speak(u);
      });
    }

    async function playAll(){
      if(playing) return;
      playing=true;
      const rate = Number($('#speed').value||1);
      const enVoice = $('#enVoice').value || voices.find(v=>/^en(-|_)/i.test(v.lang))?.name;
      for(const w of currentWords){
        if(!playing) break;
        await speak(w.phrase,'en-US',rate,enVoice);
        if(!playing) break;
        await speak(w.meaning,'ko-KR',rate*0.95,null);
      }
      playing=false;
    }
    function stopAll(){ playing=false; speechSynthesis.cancel(); }

    /*************** 데이터 로드 ***************/
    async function loadPool(){
      try{
        const res = await fetch('pool.json',{cache:'no-store'});
        pool = await res.json();
      }catch(e){
        // 최소한의 예비 데이터
        pool = [
          {phrase:"make do with", meaning:"임시방편으로 사용하다", example:"We had to make do with what we had."},
          {phrase:"get up", meaning:"일어나다", example:"I usually get up at 7 a.m."},
          {phrase:"depend on", meaning:"의지하다", example:"You can depend on me."},
          {phrase:"along with", meaning:"함께, 더불어", example:"Do you get along with your neighbors?"},
          {phrase:"figure out", meaning:"이해하다, 해결하다", example:"We need to figure out the problem."},
        ];
      }
    }

    function renderList(words){
      listEl.innerHTML='';
      words.forEach((w,i)=>{
        const row = document.createElement('div'); row.className='card';
        row.innerHTML = `
          <div class="idx">${i+1}</div>
          <div>
            <div class="word">${w.phrase}</div>
            <div class="mean">${w.meaning}</div>
            <div class="ex">예문: ${w.example||''}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:start">
            <button class="pill en">EN</button>
            <button class="pill ko">KO</button>
            <button class="star" aria-label="어려운 단어">★</button>
          </div>
        `;
        const star=row.querySelector('.star');
        const hard=LS.get(userScope().hardKey,[]);
        if(hard.find(h=>h.phrase===w.phrase)) star.classList.add('active');
        star.onclick=()=>{
          const arr=LS.get(userScope().hardKey,[]);
          const idx=arr.findIndex(h=>h.phrase===w.phrase);
          if(idx>-1){arr.splice(idx,1);star.classList.remove('active');}
          else {arr.push(w);star.classList.add('active');}
          LS.set(userScope().hardKey,arr);
        };
        row.querySelector('.en').onclick=()=>{
          const enVoice=$('#enVoice').value; const rate=Number($('#speed').value||1);
          speak(w.phrase,'en-US',rate,enVoice);
        };
        row.querySelector('.ko').onclick=()=>{
          const rate=Number($('#speed').value||1)*0.95;
          speak(w.meaning,'ko-KR',rate,null);
        };
        listEl.appendChild(row);
      });
    }

    function loadFor(date){
      const ds = fmtDate(date);
      dateText.textContent=ds;
      currentWords = pickByDate(ds,10);
      renderList(currentWords);
      // 완료 배지
      const rec = LS.get(userScope().recKey,[]);
      const done = rec.includes(ds);
      $('#doneBtn').textContent = done ? '오늘분 완료 ✓' : '오늘분 완료';
    }

    /*************** 기록 ***************/
    function openRecords(){
      const rec = LS.get(userScope().recKey,[]);
      if(!rec.length){ toast('기록이 없습니다.'); return; }
      recordsWrap.style.display='block';
      recordsWrap.innerHTML='';
      rec.sort().forEach(d=>{
        const row=document.createElement('div'); row.className='record-row';
        row.innerHTML=`
          <div style="display:flex;align-items:center;gap:10px">
            <input type="checkbox" data-date="${d}"/>
            <strong>${d}</strong>
          </div>
          <button data-go="${d}" class="pill">보기</button>
        `;
        row.querySelector('[data-go]').onclick=(e)=>{
          currentDate = dateFromStr(e.target.dataset.go);
          loadFor(currentDate);
          window.scrollTo({top:0,behavior:'smooth'});
        };
        recordsWrap.appendChild(row);
      });
    }
    function enterDeleteMode(){
      openRecords();
      // 상단에 취소/삭제 버튼 표시
      const bar=document.createElement('div');
      bar.style.display='flex'; bar.style.gap='10px'; bar.style.margin='8px 0 12px';
      bar.innerHTML=`
        <button id="cancelDel" class="btn">취소</button>
        <button id="confirmDel" class="btn btn-red">삭제하기</button>
      `;
      recordsWrap.prepend(bar);
      $('#cancelDel').onclick=()=>{ recordsWrap.style.display='none'; recordsWrap.innerHTML=''; };
      $('#confirmDel').onclick=()=>{
        const checks=[...recordsWrap.querySelectorAll('input[type=checkbox]:checked')];
        if(!checks.length){ toast('삭제할 날짜를 선택하세요.'); return; }
        const rec=LS.get(userScope().recKey,[]);
        const will=checks.map(c=>c.dataset.date);
        const next = rec.filter(d=>!will.includes(d));
        LS.set(userScope().recKey,next);
        toast('삭제했습니다.');
        recordsWrap.style.display='none'; recordsWrap.innerHTML='';
      };
    }

    /*************** 이벤트 바인딩 ***************/
    $('#openAccount').onclick=()=>$('#panel').classList.toggle('open');
    $('#gotoToday').onclick=()=>{ currentDate=new Date(); loadFor(currentDate); };
    $('#prevDay').onclick=()=>{ currentDate.setDate(currentDate.getDate()-1); loadFor(currentDate); };
    $('#nextDay').onclick=()=>{ currentDate.setDate(currentDate.getDate()+1); loadFor(currentDate); };

    $('#playAll').onclick=playAll;
    $('#stopAll').onclick=stopAll;

    $('#doneBtn').onclick=()=>{
      const key=userScope().recKey;
      const rec=LS.get(key,[]);
      const ds=dateText.textContent;
      if(!rec.includes(ds)) rec.push(ds);
      LS.set(key,rec);
      $('#doneBtn').textContent='오늘분 완료 ✓';
      toast('기록했습니다.');
    };

    $('#hardBtn').onclick=()=>{
      const arr=LS.get(userScope().hardKey,[]);
      if(!arr.length){ toast('어려운 단어가 없습니다. ★ 버튼으로 추가하세요.'); return; }
      listEl.innerHTML='';
      arr.forEach((w,i)=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`
          <div class="idx">${i+1}</div>
          <div>
            <div class="word">${w.phrase}</div>
            <div class="mean">${w.meaning}</div>
            <div class="ex">예문: ${w.example||''}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:start">
            <button class="pill en">EN</button>
            <button class="pill ko">KO</button>
            <button class="star active">★</button>
          </div>
        `;
        row.querySelector('.en').onclick=()=>{
          const enVoice=$('#enVoice').value; const rate=Number($('#speed').value||1);
          speak(w.phrase,'en-US',rate,enVoice);
        };
        row.querySelector('.ko').onclick=()=>{
          const rate=Number($('#speed').value||1)*0.95;
          speak(w.meaning,'ko-KR',rate,null);
        };
        row.querySelector('.star').onclick=()=>{
          const arr=LS.get(userScope().hardKey,[]);
          const idx=arr.findIndex(h=>h.phrase===w.phrase);
          if(idx>-1){arr.splice(idx,1);}
          LS.set(userScope().hardKey,arr);
          row.remove();
        };
        listEl.appendChild(row);
      });
    };

    $('#recBtn').onclick=()=>{ openRecords(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); };
    $('#recDelBtn').onclick=()=>{ enterDeleteMode(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); };

    $('#speed').oninput=()=>{
      const cfg=LS.get(userScope().cfgKey,{});
      cfg.speed=Number($('#speed').value||1); LS.set(userScope().cfgKey,cfg);
    };
    $('#enVoice').onchange=()=>{
      const cfg=LS.get(userScope().cfgKey,{});
      cfg.enVoice=$('#enVoice').value; LS.set(userScope().cfgKey,cfg);
    };

    /*************** 인증 ***************/
    $('#signup').onclick=async()=>{
      try{
        const e=$('#email').value.trim(), p=$('#pass').value.trim();
        await auth.createUserWithEmailAndPassword(e,p);
        toast('회원가입 성공');
      }catch(err){ toast('회원가입 실패: '+err.message); }
    };
    $('#login').onclick=async()=>{
      try{
        const e=$('#email').value.trim(), p=$('#pass').value.trim();
        await auth.signInWithEmailAndPassword(e,p);
        toast('로그인 성공');
      }catch(err){ toast('로그인 실패: '+err.message); }
    };
    $('#gLogin').onclick=async()=>{
      try{
        const provider=new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      }catch(err){ toast('구글 로그인 실패: '+err.message); }
    };
    $('#logout').onclick=()=>auth.signOut();

    auth.onAuthStateChanged(u=>{
      if(u){
        $('#authBox').style.display='none';
        $('#userBox').style.display='block';
        $('#userEmail').textContent=u.email||'';
        $('#userName').textContent=u.displayName||'';
        $('#userInitial').textContent=(u.displayName?.[0]||u.email?.[0]||'U').toUpperCase();
      }else{
        $('#authBox').style.display='block';
        $('#userBox').style.display='none';
      }
    });

    /*************** 시작 ***************/
    (async function init(){
      await loadPool();
      loadVoices();
      const cfg=LS.get(userScope().cfgKey,{speed:1});
      $('#speed').value=cfg.speed||1;
      currentDate = new Date();
      loadFor(currentDate);
    })();
  </script>
</body>
</html>
