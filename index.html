<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>오늘의 회화 영단어</title>
<style>
  :root{--blue:#1e5ef3;--blue2:#1a4fd1;--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#667085;--green:#1fb86a;--red:#e74c3c}
  *{box-sizing:border-box} body{margin:0;background:#f6f7fb;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  /* AppBar */
  .appbar{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff;padding:16px 20px;display:flex;align-items:center;gap:12px}
  .title{font-weight:800;font-size:20px;white-space:nowrap} .spacer{flex:1}
  .icon-btn{width:44px;height:44px;border-radius:999px;display:grid;place-items:center;background:rgba(255,255,255,.15);border:none;color:#fff;cursor:pointer}
  /* Toolbar */
  .toolbar{max-width:980px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .btn{height:44px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;padding:0 14px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap;cursor:pointer}
  .btn.green{background:var(--green);color:#fff;border-color:var(--green)} .btn.red{background:var(--red);color:#fff;border-color:var(--red)}
  .date-wrap{grid-column:span 12;display:grid;grid-template-columns:44px 1fr 44px;gap:8px}
  .date-box{height:44px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:800;padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row{grid-column:span 12;display:flex;gap:10px;flex-wrap:wrap} .row .btn{min-width:110px}
  .controls{max-width:980px;margin:0 auto 10px;padding:0 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .range{flex:1;height:6px} .select{height:44px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:0 10px}
  .container{max-width:980px;margin:8px auto 80px;padding:0 16px}
  .card{background:#fff;border:1px solid #eef0f3;border-radius:14px;padding:14px;margin:10px 0;display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .idx{width:34px;height:34px;border-radius:10px;background:#eef2ff;color:#1737e6;font-weight:800;display:grid;place-items:center}
  .ph{font-weight:800;font-size:18px} .mean{color:#344054} .ex{color:#667085;margin-top:6px}
  .chip{height:36px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;padding:0 10px;font-weight:800;cursor:pointer}
  .star{height:36px;border-radius:10px;border:1px solid #ffe1c7;background:#fff7ed;color:#d97706;font-weight:800;padding:0 10px;cursor:pointer}
  .log-panel{background:#fff;border:1px solid #eef0f3;border-radius:14px;padding:12px;margin-top:8px}
  .log-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}.ghost{background:#fff;border:1px solid #e5e7eb}
  .log-list{display:flex;flex-direction:column;gap:8px}.log-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #eef0f3;border-radius:10px}
  .hide{display:none!important}

  /* === Account Drawer === */
  .mask{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);opacity:0;pointer-events:none;transition:.2s;z-index:60}
  .mask.show{opacity:1;pointer-events:auto}
  .drawer{position:fixed;top:0;right:-360px;width:360px;max-width:88vw;height:100dvh;background:#fff;border-left:1px solid #e5e7eb;box-shadow:-8px 0 24px rgba(0,0,0,.06);transition:right .25s ease;z-index:61;display:flex;flex-direction:column}
  .drawer.show{right:0}
  .drawer-header{display:flex;align-items:center;gap:12px;padding:18px 16px;border-bottom:1px solid #f0f2f4}
  .drawer-title{font-weight:800;font-size:20px}
  .drawer-x{margin-left:auto;border:none;background:#f3f4f6;width:36px;height:36px;border-radius:10px;cursor:pointer}
  .drawer-body{padding:16px;overflow:auto}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .input{height:44px;border:1px solid #e5e7eb;border-radius:12px;padding:0 12px;background:#fff}
  .row-btns{display:flex;gap:10px;margin-top:10px}
  .big{height:46px;border-radius:12px;padding:0 14px;font-weight:800}
  .big.full{width:100%}
</style>
</head>
<body>
  <header class="appbar">
    <div class="title">오늘의 회화 영단어</div>
    <div class="spacer"></div>
    <button id="accountBtn" class="icon-btn" aria-label="계정">•••</button>
  </header>

  <section class="toolbar" aria-label="도구">
    <div class="date-wrap">
      <button id="prevDate" class="btn" aria-label="이전">◀</button>
      <div id="dateText" class="date-box">YYYY-MM-DD</div>
      <button id="nextDate" class="btn" aria-label="다음">▶</button>
    </div>
    <div class="row">
      <button id="playAll" class="btn">전체 재생</button>
      <button id="stopAll" class="btn">정지</button>
      <button id="markDone" class="btn green">오늘분 완료</button>
      <button id="todayBtn" class="btn">오늘의 단어</button>
      <button id="favToggle" class="btn">★ 어려운 단어</button>
      <button id="openLog" class="btn">기록</button>
      <button id="openLogDelete" class="btn red">기록 삭제</button>
    </div>
  </section>

  <div class="controls">
    <div style="font-weight:700">속도</div>
    <input id="rate" class="range" type="range" min="0.6" max="1.6" step="0.1" value="1.0">
    <select id="enVoice" class="select"><option value="">영어 음성</option></select>
    <select id="koVoice" class="select"><option value="">한국어 음성</option></select>
  </div>

  <main class="container">
    <div id="list"></div>

    <div id="logPanel" class="log-panel hide">
      <div class="log-head">
        <div style="font-weight:800">완료 기록</div>
        <div style="flex:1"></div>
        <button id="logCancel" class="btn ghost hide">취소</button>
        <button id="logDoDelete" class="btn red hide">삭제하기</button>
      </div>
      <div id="logEmpty" style="color:#667085">기록이 없습니다.</div>
      <div id="logList" class="log-list"></div>
    </div>
  </main>

  <!-- Drawer + Mask -->
  <div id="mask" class="mask"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="drawer-title">계정</div>
      <button id="drawerClose" class="drawer-x" aria-label="닫기">✕</button>
    </div>
    <div class="drawer-body">
      <!-- 로그인 폼 (Firebase 없어도 UI만 표시) -->
      <div class="field"><label>이메일</label><input id="email" class="input" type="email" placeholder="you@example.com"></div>
      <div class="field"><label>비밀번호</label><input id="password" class="input" type="password" placeholder="8자리 이상"></div>
      <div class="row-btns">
        <button id="loginBtn" class="btn big full">로그인</button>
        <button id="signupBtn" class="btn big full ghost">회원가입</button>
      </div>
      <!-- 로그인 후 표시 자리 -->
      <div id="loginInfo" class="field hide">
        <div style="font-weight:800">로그인됨</div>
        <div id="loginEmail" style="color:#667085"></div>
        <button id="logoutBtn" class="btn big red" style="margin-top:10px">로그아웃</button>
      </div>
    </div>
  </aside>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---------- Firebase(Optional) ---------- */
    (async () => {
      try {
        // 이곳에 본인 Firebase 초기화 코드를 넣을 수 있어요.
        // 실패하더라도 catch로 넘어가도록 남겨둡니다.
      } catch (e) { console.warn('Firebase init skipped:', e); }
    })();

    /* ---------- Shortcuts ---------- */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    /* ---------- Drawer Open/Close ---------- */
    const mask = $('#mask');
    const drawer = $('#drawer');
    const accountBtn = $('#accountBtn');
    const drawerClose = $('#drawerClose');

    function openDrawer(){
      drawer.classList.add('show');
      mask.classList.add('show');
      drawer.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      drawer.classList.remove('show');
      mask.classList.remove('show');
      drawer.setAttribute('aria-hidden','true');
    }
    accountBtn.addEventListener('click', openDrawer);
    drawerClose.addEventListener('click', closeDrawer);
    mask.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

    /* ---------- 기존 앱 로직 (동작 보장 버전) ---------- */
    const LS_FAV='voca_favs', LS_LOG='voca_logs';
    const listEl = $('#list');
    const dateEl = $('#dateText');
    const rateEl = $('#rate');
    const enSel = $('#enVoice');
    const koSel = $('#koVoice');
    const logPanel=$('#logPanel'), logCancel=$('#logCancel'), logDoDel=$('#logDoDelete'), logList=$('#logList'), logEmpty=$('#logEmpty');

    let POOL=[]; let currentSet=[]; let showFavOnly=false; let queued=false;

    const FALLBACK_POOL=[
      {phrase:'deal with', meaning:'다루다, 처리하다', example:'She had to deal with many problems.'},
      {phrase:'depend on', meaning:'의지하다', example:'You can depend on me.'},
      {phrase:'along with', meaning:'~와 함께', example:'Do you get along with your neighbors?'},
      {phrase:'figure out', meaning:'이해하다, 해결하다', example:'We need to figure out the answer.'},
      {phrase:'run into', meaning:'우연히 만나다', example:'I ran into an old friend.'},
      {phrase:'bring up', meaning:'언급하다, 키우다', example:'He brought up an interesting point.'},
      {phrase:'check out', meaning:'확인하다', example:'Check out this new app.'},
      {phrase:'carry on', meaning:'계속하다', example:'Please carry on with your work.'},
      {phrase:'look for', meaning:'찾다', example:'I am looking for my keys.'},
      {phrase:'get over', meaning:'극복하다', example:'It took time to get over it.'},
      {phrase:'pick up', meaning:'줍다/배우다', example:'You will pick it up soon.'},
      {phrase:'turn out', meaning:'~로 드러나다', example:'It turned out to be true.'},
    ];

    let cur = new Date();
    const fmt = d => d.toISOString().slice(0,10);
    function updateDateText(){ dateEl.textContent = fmt(cur); }

    $('#prevDate').addEventListener('click',()=>{cur.setDate(cur.getDate()-1); updateDateText(); renderForDate();});
    $('#nextDate').addEventListener('click',()=>{cur.setDate(cur.getDate()+1); updateDateText(); renderForDate();});
    $('#todayBtn').addEventListener('click',()=>{cur=new Date(); updateDateText(); renderForDate();});

    const logs = () => JSON.parse(localStorage.getItem(LS_LOG)||'{}');
    const saveLogs = o => localStorage.setItem(LS_LOG, JSON.stringify(o));
    const favs = () => new Set(JSON.parse(localStorage.getItem(LS_FAV)||'[]'));
    const saveFavs = s => localStorage.setItem(LS_FAV, JSON.stringify([...s]));

    let voices=[];
    function fillVoices(){
      voices = speechSynthesis.getVoices();
      const en=voices.filter(v=>/^en(-|_)/i.test(v.lang));
      const ko=voices.filter(v=>/^ko(-|_)/i.test(v.lang));
      enSel.innerHTML='<option value="">영어 음성</option>'+en.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
      koSel.innerHTML='<option value="">한국어 음성</option>'+ko.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
      const defEn=en.find(v=>/US|en-US/i.test(v.lang))||en[0]; const defKo=ko[0];
      if(defEn) enSel.value=defEn.name; if(defKo) koSel.value=defKo.name;
    }
    fillVoices(); if(typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged=fillVoices; }

    function speak(text, lang){
      const u=new SpeechSynthesisUtterance(text);
      u.rate=Number(rateEl.value)||1;
      if(lang.startsWith('en')&&enSel.value){const v=voices.find(v=>v.name===enSel.value); if(v) u.voice=v;}
      else if(lang.startsWith('ko')&&koSel.value){const v=voices.find(v=>v.name===koSel.value); if(v) u.voice=v;}
      u.lang=lang; speechSynthesis.speak(u);
    }

    function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19}return()=>{h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return(h^h>>>16)>>>0}}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function pickDaily(pool,dateStr,n=10){const seed=xmur3(dateStr)();const rnd=mulberry32(seed);const idxs=pool.map((_,i)=>i);for(let i=idxs.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[idxs[i],idxs[j]]=[idxs[j],idxs[i]];}return idxs.slice(0,Math.min(n,idxs.length)).map(i=>pool[i]);}

    async function loadPool(){
      try{
        const res = await fetch('./pool.json',{cache:'no-store'});
        if(!res.ok) throw new Error(res.status);
        POOL = await res.json();
      }catch(e){ console.warn('pool.json 로드 실패, 내장 데이터 사용:', e); POOL = FALLBACK_POOL; }
    }

    function buildSet(){
      const all = pickDaily(POOL, dateEl.textContent, 10);
      if(!showFavOnly) return all;
      const set=favs(); return all.filter(w=>set.has(w.phrase));
    }

    function renderList(items){
      const favset=favs(); listEl.innerHTML='';
      items.forEach((w,idx)=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="idx">${idx+1}</div>
          <div>
            <div class="ph">${w.phrase}</div>
            <div class="mean">${w.meaning}</div>
            <div class="ex">예문: ${w.example||''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;gap:6px">
              <button class="chip en">EN</button>
              <button class="chip ko">KO</button>
            </div>
            <button class="star">${favset.has(w.phrase)?'★':'☆'}</button>
          </div>`;
        card.querySelector('.en').addEventListener('click',()=>speak(w.phrase,'en-US'));
        card.querySelector('.ko').addEventListener('click',()=>speak(w.meaning,'ko-KR'));
        card.querySelector('.star').addEventListener('click',e=>{
          const set=favs();
          if(set.has(w.phrase)){ set.delete(w.phrase); e.target.textContent='☆'; }
          else { set.add(w.phrase); e.target.textContent='★'; }
          saveFavs(set); if(showFavOnly) renderForDate();
        });
        listEl.appendChild(card);
      });
    }

    async function renderForDate(){
      if(POOL.length===0) await loadPool();
      currentSet = buildSet();
      renderList(currentSet);
      renderLogsPanel(false);
    }

    $('#playAll').addEventListener('click',()=>{
      if(!currentSet.length) return; speechSynthesis.cancel(); queued=true;
      const seq=[]; currentSet.forEach(w=>{seq.push({t:w.phrase,lang:'en-US'}); if(w.example) seq.push({t:w.example,lang:'en-US'}); seq.push({t:w.meaning,lang:'ko-KR'});});
      let i=0; const next=()=>{ if(!queued||i>=seq.length){queued=false;return;} const it=seq[i++]; const u=new SpeechSynthesisUtterance(it.t); u.rate=Number(rateEl.value)||1;
        if(it.lang.startsWith('en')&&enSel.value){const v=voices.find(v=>v.name===enSel.value); if(v) u.voice=v;}
        else if(it.lang.startsWith('ko')&&koSel.value){const v=voices.find(v=>v.name===koSel.value); if(v) u.voice=v;}
        u.lang=it.lang; u.onend=next; speechSynthesis.speak(u); };
      next();
    });
    $('#stopAll').addEventListener('click',()=>{queued=false; speechSynthesis.cancel();});
    $('#markDone').addEventListener('click',()=>{
      const d=dateEl.textContent; const l=logs(); l[d]=true; saveLogs(l);
      alert('오늘분 완료로 기록했습니다.'); cur.setDate(cur.getDate()+1); updateDateText(); renderForDate();
    });
    $('#favToggle').addEventListener('click',()=>{showFavOnly=!showFavOnly; renderForDate();});

    function renderLogsPanel(asDelete=false, open=false){
      const l=logs(); const dates=Object.keys(l).sort(); logList.innerHTML='';
      if(dates.length===0) logEmpty.classList.remove('hide'); else logEmpty.classList.add('hide');
      dates.forEach(d=>{
        const row=document.createElement('div'); row.className='log-item';
        row.innerHTML=`${asDelete?`<input type="checkbox" data-date="${d}">`:''}<div style="font-weight:800">${d}</div><div style="flex:1"></div><button class="btn ghost go">이동</button>`;
        row.querySelector('.go').addEventListener('click',()=>{cur=new Date(d); updateDateText(); renderForDate(); window.scrollTo({top:0,behavior:'smooth'});});
        logList.appendChild(row);
      });
      $('#logCancel').classList.toggle('hide',!asDelete);
      $('#logDoDelete').classList.toggle('hide',!asDelete);
      logPanel.classList.remove('hide'); if(open) window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
    $('#openLog').addEventListener('click',()=>renderLogsPanel(false,true));
    $('#openLogDelete').addEventListener('click',()=>renderLogsPanel(true,true));
    $('#logCancel').addEventListener('click',()=>renderLogsPanel(false,true));
    $('#logDoDelete').addEventListener('click',()=>{
      const checks=$$('#logList input[type=checkbox]'); const sel=[...checks].filter(c=>c.checked).map(c=>c.dataset.date);
      if(!sel.length) return alert('삭제할 날짜를 선택하세요.');
      const l=logs(); sel.forEach(d=>delete l[d]); saveLogs(l); renderLogsPanel(true,true); if(Object.keys(l).length===0) renderLogsPanel(false,true);
    });

    /* 시작 */
    updateDateText();
    renderForDate();
  });
  </script>
</body>
</html>
