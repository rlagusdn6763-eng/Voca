<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>오늘의 회화 영단어</title>
<style>
  :root{
    /* 밝은 톤 팔레트 */
    --bg:#eef2f7;            /* 페이지 배경 */
    --ink:#0f172a;           /* 기본 글자색 */
    --muted:#54657e;         /* 보조 글자 */
    --card:#ffffff;          /* 카드 배경 */
    --border:#d9e1ee;        /* 경계선 */
    --accent:#0ea5a5;        /* 포인트 */
    --accent-weak:#9be2e2;   /* 포인트 옅은 색 */
    --warn:#b45309;
    --ok:#0f766e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink); background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
  }
  header{max-width:980px;margin:24px auto 10px;padding:0 16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  h1{font-size:28px;margin:0 8px 0 0}
  .sub{color:var(--muted);font-size:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;background:#f7fbff}
  .badge-ok{background:#e7f7f5;border-color:#bfe9e5;color:#0b4c47}
  .btn{border:1px solid var(--border);background:#f8fbff;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn:hover{border-color:#c9d6ea;background:#f2f7ff}
  .btn.primary{background:#e8fbfb;border-color:var(--accent-weak);color:#086868}
  .btn.ok{background:#e9f8f6;border-color:#bfe9e5;color:#0b4c47}
  .btn.warn{background:#fff5e8;border-color:#f6d3a1;color:#7a4a08}
  .datebox{display:flex;align-items:center;gap:8px}
  .date{font-variant-numeric:tabular-nums;font-weight:800;letter-spacing:.2px}
  main{max-width:980px;margin:8px auto 32px;padding:0 16px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:14px 16px; display:grid; gap:8px; box-shadow:0 2px 10px rgba(10,30,80,.06)
  }
  .grid{display:grid;gap:14px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .en{font-size:20px;font-weight:800}
  .ko{font-size:15px;color:var(--muted)}
  .ex{font-size:13px;color:#334155;background:#f0f6ff;border-left:4px solid var(--accent);padding:8px;border-radius:8px}
  .play{margin-left:auto}
  .star{
    border:none;background:transparent;cursor:pointer;font-size:20px;line-height:1;color:#c3cad5
  }
  .star.active{color:#f59e0b} /* ★ 채움 */
  .tabs{display:flex;gap:8px;margin:14px 0}
  .tab-btn{padding:8px 12px;border:1px solid var(--border);background:#f7fbff;border-radius:10px;cursor:pointer}
  .tab-btn.active{border-color:var(--accent-weak);background:#e8fbfb;color:#075e5e}
  .list{display:grid;gap:10px}
  .empty{color:var(--muted);padding:10px}
  .footer{margin-top:18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .select{background:#fff;color:var(--ink);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
  .pill{padding:4px 8px;border-radius:999px;background:#eef6ff;border:1px solid var(--border);font-size:12px;color:#335}
</style>
</head>
<body>
  <header>
    <h1>오늘의 회화 영단어</h1>
    <span id="doneBadge" class="chip badge-ok" hidden>✔ 오늘분 학습 완료</span>
    <div class="row" style="margin-left:auto">
      <div class="datebox">
        <button id="prevBtn" class="btn" title="이전 날짜">◀</button>
        <span id="dateLabel" class="date"></span>
        <button id="nextBtn" class="btn" title="다음 날짜">▶</button>
      </div>
      <button id="speakAllBtn" class="btn primary">전체 재생</button>
      <button id="completeBtn" class="btn ok">오늘분 완료</button>
    </div>
    <div class="row" style="width:100%"><span class="sub">카드를 클릭해 발음(영→한)을 들어보세요 · 영어는 영어 음성, 한국어 뜻은 한국어 음성으로 읽어요.</span></div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="today">오늘 단어</button>
      <button class="tab-btn" data-tab="history">기록 보기</button>
      <button class="tab-btn" data-tab="hard">어려운 단어</button>
    </div>

    <section id="todayTab">
      <div id="words" class="grid"></div>
      <div class="footer">
        <label class="chip">속도 <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" style="vertical-align:middle;margin-left:8px"></label>
        <span class="sub">발음이 어색하면 기기의 영어/한국어 음성을 최신으로 바꿔보세요.</span>
      </div>
    </section>

    <section id="historyTab" hidden>
      <div class="row" style="margin-bottom:12px">
        <select id="dateFilter" class="select"></select>
        <button id="viewDayBtn" class="btn">보기</button>
        <button id="clearHistBtn" class="btn warn">기록 초기화</button>
      </div>
      <div id="histList" class="list"></div>
    </section>

    <section id="hardTab" hidden>
      <div class="row" style="margin-bottom:12px">
        <span class="pill" id="hardCount">0개 저장됨</span>
        <button id="clearHardBtn" class="btn warn">어려운 단어 비우기</button>
      </div>
      <div id="hardList" class="list"></div>
    </section>
  </main>

<script>
(() => {
  /* ---------- 설정 & 저장 키 ---------- */
  const WORDS_URLS = ["./words.json","./Voca/words.json"];
  const POOL_URLS  = ["./pool.json","./Voca/pool.json"];
  const STORE = {
    offset:"voca-day-offset",
    history:"voca-history",
    completed:"voca-completed",
    hard:"voca-hard"
  };

  /* ---------- 유틸 ---------- */
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const midnight = (d=new Date())=>{const x=new Date(d);x.setHours(0,0,0,0);return x;}
  const loadJSON = async (urls)=>{
    for (const u of urls){ try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok) return await r.json(); }catch(e){} }
    return null;
  };
  const seededPick=(arr,count,seedStr)=>{
    let seed=0; for(const ch of seedStr) seed=(seed*31+ch.charCodeAt(0))>>>0;
    const rnd=()=> (seed=(seed*1664525+1013904223)>>>0, (seed>>>0)/4294967296);
    const idx=[...arr.keys()];
    for(let i=idx.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1)); [idx[i],idx[j]]=[idx[j],idx[i]];}
    return idx.slice(0,Math.min(count,arr.length)).map(i=>arr[i]);
  };

  /* ---------- 상태 ---------- */
  let offset = Number(localStorage.getItem(STORE.offset)||"0");
  const completedMap = JSON.parse(localStorage.getItem(STORE.completed)||"{}");
  const history = JSON.parse(localStorage.getItem(STORE.history)||"[]");
  const hard = JSON.parse(localStorage.getItem(STORE.hard)||"[]"); // {phrase, meaning, example, savedAt}

  const getDisplayDate = ()=>{ const d=midnight(); d.setDate(d.getDate()+offset); return d; };

  /* ---------- 음성 ---------- */
  const speak=(text,lang,rate=1)=>{
    if(!window.speechSynthesis) return;
    const u=new SpeechSynthesisUtterance(text); u.lang=lang; u.rate=rate;
    const vs=speechSynthesis.getVoices().filter(v=>v.lang.startsWith(lang)); if(vs.length) u.voice=vs[0];
    speechSynthesis.speak(u);
  };

  /* ---------- 렌더링 ---------- */
  const dateLabel=$("#dateLabel"), doneBadge=$("#doneBadge"), listEl=$("#words"),
        histList=$("#histList"), dateFilter=$("#dateFilter"),
        hardList=$("#hardList"), hardCount=$("#hardCount");

  const isSameWord=(a,b)=> (a.phrase||a.word)===(b.phrase||b.word) && (a.meaning||"")==(b.meaning||"");

  const toggleHard=(word)=>{
    const i=hard.findIndex(w=>isSameWord(w,word));
    if(i>=0){ hard.splice(i,1); }
    else{ hard.push({...word,savedAt:Date.now()}); }
    localStorage.setItem(STORE.hard,JSON.stringify(hard));
    updateHardUI();
  };

  const updateHardUI=()=>{
    hardCount.textContent=`${hard.length}개 저장됨`;
    // hard 탭 리스트
    hardList.innerHTML="";
    if(!hard.length){ hardList.innerHTML=`<div class="empty">저장된 어려운 단어가 없습니다.</div>`; return; }
    hard.forEach(w=>{
      const card=document.createElement("div"); card.className="card";
      const top=document.createElement("div"); top.className="row";
      const en=document.createElement("div"); en.className="en"; en.textContent=w.phrase||w.word||"";
      const star=document.createElement("button"); star.className="star active"; star.innerHTML="★"; star.title="어려운 단어에서 제거";
      star.onclick=()=>{ toggleHard(w); renderTodayStarStates(); updateHardUI(); };
      const play=document.createElement("button"); play.className="btn play"; play.textContent="▶ 발음";
      play.onclick=()=>{ const rate=Number($("#rate").value||"1"); speak(en.textContent,"en-US",rate); if(w.meaning) setTimeout(()=>speak(w.meaning,"ko-KR",rate),350); };
      top.append(en,star,play);
      const ko=document.createElement("div"); ko.className="ko"; ko.textContent=w.meaning||"";
      const ex=document.createElement("div"); ex.className="ex"; ex.textContent=w.example?`예문: ${w.example}`:"";
      card.append(top,ko,ex); hardList.append(card);
    });
  };

  const renderTodayStarStates=()=>{
    // 오늘 탭 카드들의 ★ 상태 동기화
    listEl.querySelectorAll(".card").forEach(card=>{
      const phrase=card.querySelector(".en")?.textContent||"";
      const meaning=card.querySelector(".ko")?.textContent||"";
      const inHard = hard.some(w=> (w.phrase||w.word)===phrase && (w.meaning||"")===meaning );
      const star=card.querySelector(".star");
      if(star){ star.classList.toggle("active",inHard); }
    });
  };

  const renderWords=(words=[])=>{
    listEl.innerHTML="";
    if(!words.length){ listEl.innerHTML=`<div class="empty">단어가 없습니다.</div>`; return; }
    words.forEach(w=>{
      const card=document.createElement("div"); card.className="card";
      const top=document.createElement("div"); top.className="row";
      const en=document.createElement("div"); en.className="en"; en.textContent=w.phrase||w.word||"";
      // ★ 어려운 단어 토글
      const star=document.createElement("button"); star.className="star"; star.innerHTML="★"; star.title="어려운 단어로 저장/해제";
      star.onclick=()=>{ toggleHard({phrase:en.textContent, meaning:w.meaning||"", example:w.example||""}); renderTodayStarStates(); };
      const play=document.createElement("button"); play.className="btn play"; play.textContent="▶ 발음";
      play.onclick=()=>{ const rate=Number($("#rate").value||"1"); speak(en.textContent,"en-US",rate); if(w.meaning) setTimeout(()=>speak(w.meaning,"ko-KR",rate),350); };
      top.append(en,star,play);
      const ko=document.createElement("div"); ko.className="ko"; ko.textContent=w.meaning||"";
      const ex=document.createElement("div"); ex.className="ex"; ex.textContent=w.example?`예문: ${w.example}`:"";
      card.append(top,ko,ex); listEl.append(card);
    });
    renderTodayStarStates();
  };

  const populateHistoryFilter=()=>{
    const dates=[...new Set(history.map(h=>h.date))].sort();
    dateFilter.innerHTML = dates.length ? dates.map(d=>`<option value="${d}">${d}</option>`).join("") : `<option value="">기록 없음</option>`;
  };
  const renderHistory=()=>{
    histList.innerHTML=""; const sel=dateFilter.value; const items=sel?history.filter(h=>h.date===sel):history;
    if(!items.length){ histList.innerHTML=`<div class="empty">기록이 없습니다.</div>`; return; }
    items.sort((a,b)=>a.date.localeCompare(b.date));
    items.forEach(h=>{
      const card=document.createElement("div"); card.className="card";
      const head=document.createElement("div"); head.className="row";
      head.innerHTML=`<strong>${h.date}</strong><span class="chip">완료: ${new Date(h.completedAt).toLocaleString()}</span>`;
      card.append(head);
      (h.words||[]).forEach(w=>{
        const row=document.createElement("div"); row.style.marginTop="6px";
        row.innerHTML=`<div class="en">${w.phrase||w.word}</div><div class="ko">${w.meaning||""}</div>${w.example?`<div class="ex">예문: ${w.example}</div>`:""}`;
        card.append(row);
      });
      histList.append(card);
    });
  };

  /* ---------- 데이터 로드(날짜별) ---------- */
  const loadForDate = async (dateObj)=>{
    const dateStr=fmt(dateObj); dateLabel.textContent=dateStr; doneBadge.hidden=!completedMap[dateStr];
    const isToday = (fmt(midnight())===dateStr);

    let todays=null;
    const wjson = await loadJSON(WORDS_URLS);
    if (isToday && Array.isArray(wjson)) {
      todays = wjson;
    } else if (wjson && Array.isArray(wjson.words) && (!wjson.date || wjson.date===dateStr)) {
      todays = wjson.words;
    }

    if (!todays || !todays.length){
      const pool = await loadJSON(POOL_URLS);
      todays = Array.isArray(pool) ? seededPick(pool,10,dateStr) : [];
    }
    renderWords(todays);
    return todays;
  };

  /* ---------- 상단 버튼 ---------- */
  $("#prevBtn").onclick=async()=>{ offset-=1; localStorage.setItem(STORE.offset,String(offset)); await loadForDate(getDisplayDate()); };
  $("#nextBtn").onclick=async()=>{ offset+=1; localStorage.setItem(STORE.offset,String(offset)); await loadForDate(getDisplayDate()); };

  $("#speakAllBtn").onclick=()=>{
    const cards=listEl.querySelectorAll(".card"); const rate=Number($("#rate").value||"1"); let i=0;
    const playNext=()=>{ if(i>=cards.length) return; const en=cards[i].querySelector(".en")?.textContent||""; const ko=cards[i].querySelector(".ko")?.textContent||"";
      speak(en,"en-US",rate); setTimeout(()=>{ if(ko) speak(ko,"ko-KR",rate); setTimeout(()=>{i++;playNext();},500); },420);
    }; playNext();
  };

  $("#completeBtn").onclick=async()=>{
    const dateStr=fmt(getDisplayDate());
    if(completedMap[dateStr]){ alert("이미 완료로 기록된 날짜입니다."); return; }
    const words=[...document.querySelectorAll("#words .card")].map(c=>({
      phrase:c.querySelector(".en")?.textContent||"",
      meaning:c.querySelector(".ko")?.textContent||"",
      example:(c.querySelector(".ex")?.textContent||"").replace(/^예문:\s*/,"")
    }));
    completedMap[dateStr]=true; localStorage.setItem(STORE.completed,JSON.stringify(completedMap));
    history.push({date:dateStr,words,completedAt:Date.now()}); localStorage.setItem(STORE.history,JSON.stringify(history));
    doneBadge.hidden=false; populateHistoryFilter();
    // 다음날로 이동
    offset+=1; localStorage.setItem(STORE.offset,String(offset));
    await loadForDate(getDisplayDate());
  };

  /* ---------- 탭 ---------- */
  $$(".tab-btn").forEach(btn=>{
    btn.onclick=()=>{
      $$(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab=btn.dataset.tab;
      $("#todayTab").hidden=tab!=="today";
      $("#historyTab").hidden=tab!=="history";
      $("#hardTab").hidden=tab!=="hard";
      if(tab==="history"){ populateHistoryFilter(); renderHistory(); }
      if(tab==="hard"){ updateHardUI(); }
    };
  });
  $("#viewDayBtn").onclick=()=>renderHistory();
  $("#clearHistBtn").onclick=()=>{
    if(!confirm("모든 기록을 삭제할까요?")) return;
    localStorage.removeItem(STORE.history); localStorage.removeItem(STORE.completed); localStorage.removeItem(STORE.offset);
    while(history.length) history.pop(); for(const k in completedMap) delete completedMap[k]; offset=0;
    populateHistoryFilter(); renderHistory(); loadForDate(getDisplayDate());
  };
  $("#clearHardBtn").onclick=()=>{
    if(!hard.length) return alert("저장된 단어가 없습니다.");
    if(!confirm("저장된 어려운 단어를 모두 비울까요?")) return;
    hard.splice(0,hard.length); localStorage.setItem(STORE.hard,JSON.stringify(hard));
    updateHardUI(); renderTodayStarStates();
  };

  speechSynthesis?.addEventListener("voiceschanged",()=>{});
  (async()=>{ await loadForDate(getDisplayDate()); populateHistoryFilter(); updateHardUI(); })();
})();
</script>
</body>
</html>
