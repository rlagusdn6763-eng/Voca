<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>오늘의 회화 영단어</title>
<style>
  :root{
    --blue:#1f6ff0; --blue2:#0e5de5; --green:#15a36e; --red:#e64545;
    --card:#ffffff; --bg:#f6f7fb; --text:#0b1220; --muted:#7b8194; --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
       Apple SD Gothic Neo,Malgun Gothic,Segoe UI Emoji,Arial,sans-serif}
  /* 헤더 */
  .appbar{position:sticky;top:0;z-index:20;padding:14px 16px 18px;
          background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff}
  .appbar .row{display:flex;align-items:center;justify-content:space-between}
  .brand .sub{font-weight:800;letter-spacing:-.2px;opacity:.95}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;
            width:44px;height:44px;border-radius:14px;border:0;cursor:pointer;
            color:#fff;background:rgba(255,255,255,.16);backdrop-filter:blur(6px)}
  /* 본문 */
  .container{padding:14px 16px 28px;max-width:860px;margin:0 auto}
  .panel{background:var(--card);border-radius:var(--radius);padding:16px;
         box-shadow:0 6px 24px rgba(20,32,80,.08)}
  .datebar{display:grid;grid-template-columns:56px 1fr 56px;gap:10px;align-items:center;margin-bottom:12px}
  .round{height:44px;border-radius:14px;border:1px solid #e7eaf3;background:#fff;cursor:pointer;font-weight:700}
  .date-chip{width:100%;text-align:center;padding:10px 12px;border-radius:24px;background:#fff;border:1px solid #e9ecf2;
             font-weight:800;letter-spacing:.5px;font-size:clamp(18px,3.5vw,22px);line-height:1.1;color:#1b1f2a}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{padding:14px 10px;border-radius:14px;border:1px solid #e7eaf3;background:#fff;font-weight:800;cursor:pointer}
  .btn.green{background:var(--green);border-color:var(--green);color:#fff}
  .btn.red{background:var(--red);border-color:var(--red);color:#fff}
  .row2{display:flex;gap:12px;margin-top:12px;align-items:center;flex-wrap:wrap}
  .tiny-icon{width:44px;height:44px;border-radius:12px;border:1px solid #e7eaf3;background:#fff;
             display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;font-weight:900}
  .section{margin-top:14px}
  .selects{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  select, .range{width:100%}
  .list-area{margin-top:16px}
  .card{background:#fff;border:1px solid #e7eaf3;border-radius:16px;padding:14px;margin-bottom:12px}
  .title{font-weight:900;font-size:18px}
  .muted{color:#6b7280}
  .play-mini{border:1px solid #e7eaf3;background:#fff;border-radius:10px;height:36px;padding:0 10px;cursor:pointer}
  .flex{display:flex;gap:10px;align-items:center;justify-content:space-between}
  /* 로그인 슬라이더 */
  .sheet{position:fixed;inset:0;z-index:50;display:none}
  .sheet.open{display:block}
  .sheet .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.32)}
  .sheet .panel{
    position:absolute;top:0;right:0;height:100vh;max-width:520px;width:min(92vw,520px);
    background:#fff;border-radius:16px 0 0 16px;padding:20px 16px 28px;
    box-shadow:-10px 0 28px rgba(0,0,0,.18);overflow:auto}
  .sheet .close{position:sticky;top:0;margin-left:auto;border:0;background:#f0f2f7;border-radius:12px;width:40px;height:40px;cursor:pointer}
  .field{display:flex;flex-direction:column;gap:6px;margin:12px 0}
  .input{height:48px;border:1px solid #e7eaf3;border-radius:12px;padding:0 12px;font-size:16px}
  .primary{display:block;width:100%;height:48px;border-radius:12px;border:0;background:var(--blue2);color:#fff;font-weight:800;cursor:pointer}
  .muted-link{color:var(--muted);text-decoration:none}
  /* 기록 삭제는 기록 탭일 때만 보임 */
  #btnDeleteLog{display:none}
  .logs-open #btnDeleteLog{display:inline-block}
</style>
</head>
<body>
  <!-- 헤더 -->
  <header class="appbar">
    <div class="row">
      <div class="brand"><div class="sub">오늘의 회화 영단어</div></div>
      <div style="display:flex;gap:10px">
        <button id="playAllBtn" class="icon-btn" title="전체 재생">▶</button>
        <button id="moreBtn" class="icon-btn" title="계정">⋯</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="panel" id="mainPanel">
      <!-- 날짜 바 -->
      <div class="datebar">
        <button id="prevDayBtn" class="round" aria-label="이전 날짜">◀</button>
        <div id="dateChip" class="date-chip">YYYY-MM-DD</div>
        <button id="nextDayBtn" class="round" aria-label="다음 날짜">▶</button>
      </div>

      <!-- 컨트롤 -->
      <div class="grid">
        <button id="btnAllPlay" class="btn">전체 재생</button>
        <button id="btnStop" class="btn">정지</button>
        <button id="btnDone" class="btn green">오늘분 완료</button>
        <button id="btnToday" class="btn">오늘의 단어</button>
      </div>

      <div class="row2">
        <button id="btnHardTiny" class="tiny-icon" title="어려운 단어">☆</button>
        <button id="btnLog" class="btn" style="flex:1">기록</button>
        <button id="btnDeleteLog" class="btn red" style="flex:1">기록 삭제</button>
        <button id="btnStudy" class="btn" style="flex:1">학습하기</button>
      </div>

      <div class="section">
        <div style="font-weight:800;margin-bottom:6px">속도</div>
        <input id="speedRange" class="range" type="range" min="0.6" max="1.4" step="0.1" value="1.0">
        <div class="selects">
          <select id="selEn"></select>
          <select id="selKo"></select>
        </div>
      </div>

      <!-- 단어 리스트 -->
      <div id="listArea" class="list-area"></div>
    </section>
  </main>

  <!-- 로그인 슬라이더 -->
  <aside id="accountSheet" class="sheet" aria-hidden="true">
    <div class="backdrop" id="sheetBackdrop"></div>
    <div class="panel" role="dialog" aria-label="계정">
      <button class="close" id="sheetClose" aria-label="닫기">✕</button>
      <h2 style="margin:6px 4px 10px;font-size:28px">계정</h2>
      <div class="field">
        <label>이메일</label>
        <input id="email" class="input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <label>비밀번호</label>
        <input id="password" class="input" type="password" placeholder="8자리 이상"/>
      </div>
      <button class="primary" id="loginBtn">로그인</button>
      <div style="margin-top:12px">
        <a href="#" class="muted-link" id="noLogin">로그인하지 않음</a>
      </div>
    </div>
  </aside>

<script>
/* ========== 날짜/포맷 ========== */
const dateChip = document.getElementById('dateChip');
let currentDate = new Date();

const fmt = (d) => {
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
};
function renderDateChip(){ dateChip.textContent = fmt(currentDate); }
function setDate(d){ currentDate = new Date(d.getFullYear(), d.getMonth(), d.getDate()); renderDateChip(); onDateChanged(fmt(currentDate)); }
function shiftDate(days){ const d=new Date(currentDate); d.setDate(d.getDate()+days); setDate(d); }
function goToday(){ setDate(new Date()); }
function markDoneAndNext(){ shiftDate(1); }

/* ========== fetch helpers ========== */
async function tryFetchJSON(paths){
  for (const p of paths){
    try{
      const r = await fetch(p,{cache:'no-store'});
      if (r.ok) return r.json();
    }catch(e){}
  }
  throw new Error('pool.json을 찾지 못했습니다.');
}

/* ========== 시드난수 & 선택 ========== */
function hashString(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function xorshift(seed){ let x=seed>>>0; return ()=>{ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/4294967296; }; }
function pickNDeterministic(arr,n,seed){
  const rnd = xorshift(seed); const pool=[...arr]; const out=[];
  while(out.length<Math.min(n,pool.length)){ const i=Math.floor(rnd()*pool.length); out.push(pool[i]); pool.splice(i,1); }
  return out;
}

/* ========== pool에서 불러오기 (항상 pool.json만) ========== */
let POOL_CACHE = null;
async function loadPool(){
  if (POOL_CACHE) return POOL_CACHE;
  const pool = await tryFetchJSON([`./pool.json`,`pool.json`,`/pool.json`,`./data/pool.json`,`data/pool.json`,`/data/pool.json`]);
  POOL_CACHE = Array.isArray(pool) ? pool : (Array.isArray(pool.words)? pool.words : []);
  return POOL_CACHE;
}

/* 다양한 키 자동 매핑 */
function pickVal(obj, keys){
  for (const k of keys){
    const v = obj?.[k];
    if (v==null) continue;
    if (typeof v === 'string' && v.trim()) return v.trim();
    if (typeof v === 'number') return String(v);
    if (typeof v === 'object'){
      // 예: example: { en: "...", ko: "..." }
      if (v.en && String(v.en).trim()) return String(v.en).trim();
      if (v.english && String(v.english).trim()) return String(v.english).trim();
    }
  }
  return '';
}
function normalizeItem(w){
  const enKeys = ['en','word','term','phrase','phrasal','expression','eng','english','title','head','q','answer','ans','target','key','text_en','front','prompt','item','v'];
  const koKeys = ['ko','mean','meaning','kr','kor','korean','translation','trans','gloss','def','definition','explain','desc','back','text_ko','mean_ko','kr_meaning'];
  const exKeys = ['ex','example','sentence','sample','eg','usage','ex_en','enExample','example_en','usage_en','s','exSentence'];

  let en = pickVal(w, enKeys);
  let ko = pickVal(w, koKeys);

  // 예문은 문자열/객체 모두 허용
  let ex = '';
  for (const k of exKeys){
    const v = w[k];
    if (!v) continue;
    if (typeof v === 'string' && v.trim()){ ex = v.trim(); break; }
    if (typeof v === 'object'){
      if (v.en && String(v.en).trim()){ ex = String(v.en).trim(); break; }
      if (v.english && String(v.english).trim()){ ex = String(v.english).trim(); break; }
    }
  }
  // 예문 ko가 따로 있을 수도 있음 (사용은 안하지만 보존)
  const exKo = pickVal(w, ['ex_ko','example_ko','sentence_ko','sample_ko','usage_ko','koExample','exampleKr']);

  return { en, ko, ex, exKo };
}

async function loadWordsForDate(iso){
  const pool = await loadPool();
  const picked = pickNDeterministic(pool,10,hashString(iso));
  return picked.map(normalizeItem);
}

/* ========== Web Speech ========== */
const selEn = document.getElementById('selEn');
const selKo = document.getElementById('selKo');
const speedRange = document.getElementById('speedRange');

function populateVoices(){
  const voices = speechSynthesis.getVoices();
  function fill(select, prefer){
    const opts = voices
      .filter(v=>v.lang.toLowerCase().includes(prefer))
      .sort((a,b)=> (a.lang>a.lang)-(a.lang<b.lang));
    select.innerHTML = opts.map(v=>`<option value="${v.name}">${v.name} — ${v.lang}</option>`).join('')
      || `<option value="">(기본 음성)</option>`;
  }
  fill(selEn,'en'); fill(selKo,'ko');
}
speechSynthesis.onvoiceschanged = populateVoices;
populateVoices();

function speak(text, voiceName){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = speechSynthesis.getVoices().find(v=>v.name===voiceName);
  if (v) u.voice = v;
  u.rate = Number(speedRange.value || 1.0);
  speechSynthesis.speak(u);
}

/* ========== 렌더링 ========== */
const listArea = document.getElementById('listArea');

function renderWords(list){
  listArea.innerHTML = list.map((w,i)=>`
    <div class="card">
      <div class="flex">
        <div class="title">${i+1}. ${escapeHtml(w.en || '(단어 없음)')}</div>
        <button class="play-mini" data-index="${i}" aria-label="재생">▶</button>
      </div>
      <div class="muted" style="margin-top:6px">${escapeHtml(w.ko || '')}</div>
      ${w.ex ? `<div class="muted" style="margin-top:6px">예문: ${escapeHtml(w.ex)}</div>`:''}
    </div>
  `).join('');

  // 각 항목 재생 버튼 바인딩
  listArea.querySelectorAll('.play-mini').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = Number(btn.dataset.index);
      const item = list[idx];
      speechSynthesis.cancel();
      if (item.en) speak(item.en, selEn.value);
      if (item.ko) speak(item.ko, selKo.value);
      if (item.ex) speak(item.ex, selEn.value);
    });
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function onDateChanged(iso){
  listArea.innerHTML = '<div class="card muted">로딩 중…</div>';
  try{
    const words = await loadWordsForDate(iso);
    renderWords(words);
  }catch(e){
    listArea.innerHTML = `<div class="card muted">로딩 실패: ${escapeHtml(e.message||'')}</div>`;
  }
}

/* ========== 로그인 슬라이더 ========== */
const sheet = document.getElementById('accountSheet');
const openSheet = ()=>{ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; };
const closeSheet = ()=>{ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); document.body.style.overflow=''; };
document.getElementById('moreBtn').addEventListener('click', openSheet);
document.getElementById('sheetClose').addEventListener('click', closeSheet);
document.getElementById('sheetBackdrop').addEventListener('click', closeSheet);

/* ========== 상단 버튼 동작 ========== */
document.getElementById('prevDayBtn').addEventListener('click', ()=>shiftDate(-1));
document.getElementById('nextDayBtn').addEventListener('click', ()=>shiftDate(1));
document.getElementById('btnDone').addEventListener('click', markDoneAndNext);
document.getElementById('btnToday').addEventListener('click', goToday);

document.getElementById('btnAllPlay').addEventListener('click', ()=>{
  // 화면에 보이는 전체 항목 순서대로 재생
  const cards = listArea.querySelectorAll('.play-mini');
  let i=0; speechSynthesis.cancel();
  const playNext=()=>{
    if(i>=cards.length) return;
    cards[i++].click();
    setTimeout(playNext, 2200);
  };
  playNext();
});
document.getElementById('btnStop').addEventListener('click', ()=>speechSynthesis.cancel());

const mainPanel = document.getElementById('mainPanel');
document.getElementById('btnLog').addEventListener('click', ()=>{
  mainPanel.classList.toggle('logs-open'); // 기록 탭일 때만 삭제 버튼 노출
});
document.getElementById('btnDeleteLog').addEventListener('click', ()=>alert('선택 기록 삭제 기능 연결'));

document.getElementById('btnStudy').addEventListener('click', ()=>{
  const iso = fmt(currentDate);
  location.href = `study.html?date=${encodeURIComponent(iso)}`;
});

/* ========== 초기화 ========== */
function init(){ goToday(); }
init();
</script>
</body>
</html>
