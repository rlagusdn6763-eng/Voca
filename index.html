<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜¤ëŠ˜ì˜ íšŒí™” ì˜ë‹¨ì–´</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#e7ecf5;
      --brand:#2a62ff; --brand-ink:#fff; --ok:#18a957; --danger:#f04438;
      --shadow:0 10px 30px rgba(14,18,26,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
    /* í—¤ë” */
    .appbar{
      position:sticky;top:0;z-index:5;
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 20px;background:linear-gradient(90deg,#2a62ff,#2250d8);color:#fff;
      box-shadow:var(--shadow)
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .dot-btn{
      width:36px;height:36px;border-radius:50%;
      background:rgba(255,255,255,.18);display:grid;place-items:center;border:none;cursor:pointer
    }
    .dot-btn span{width:6px;height:6px;border-radius:50%;background:#fff;box-shadow:0 -8px 0 #fff,0 8px 0 #fff}
    .container{padding:18px;max-width:980px;margin:0 auto}

    /* ì»¨íŠ¸ë¡¤ ë°” */
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
    .chip{padding:10px 14px;border-radius:12px;border:1px solid var(--muted);background:#fff;font-weight:700}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand);color:var(--brand-ink)}
    .btn.ghost{background:#fff;border-color:var(--muted)}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.warn{background:var(--danger);color:#fff}
    .sel{padding:10px;border-radius:12px;border:1px solid var(--muted);background:#fff}
    .num{width:36px;height:36px;border-radius:12px;background:#e9efff;color:#2144c7;display:grid;place-items:center;font-weight:900}

    /* ì¹´ë“œ */
    .card{background:var(--card);border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .word{font-size:20px;font-weight:900}
    .mean{margin:.4rem 0 0;color:#334155}
    .ex{margin:.6rem 0 0;color:#475569}
    .tag{padding:8px 10px;border-radius:12px;border:1px solid var(--muted);background:#fff;font-weight:800}
    .fav{width:40px;height:40px;border-radius:12px;border:1px solid var(--muted);background:#fff;display:grid;place-items:center;font-size:20px;cursor:pointer}

    /* ìŒì„±/ì†ë„ */
    .range{accent-color:#2a62ff;width:220px}

    /* ì˜¤ë²„ë ˆì´ + ìŠ¬ë¼ì´ë“œ íŒ¨ë„ */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:39}
    .overlay.show{display:block}
    .sheet{
      position:fixed;top:0;right:-360px;z-index:40;width:320px;max-width:90vw;height:100%;
      background:#fff;box-shadow:-12px 0 30px rgba(0,0,0,.18);transition:right .28s ease;
      padding:20px;overflow-y:auto
    }
    .sheet.open{right:0}
    .sheet h3{margin:6px 0 16px;font-size:22px}
    .field{margin:10px 0}
    .input{width:100%;padding:12px;border:1px solid var(--muted);border-radius:12px}
    .full{width:100%}
    .logout{margin-top:8px}

    /* ì œëª©ì¤„ ìš°ì¸¡ ê³ ì • ë„íŠ¸ ë²„íŠ¼ */
    .title-wrap{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="appbar">
    <div class="title">ì˜¤ëŠ˜ì˜ íšŒí™” ì˜ë‹¨ì–´</div>
    <div class="title-wrap">
      <button id="accountBtn" class="dot-btn" aria-label="ê³„ì • ì—´ê¸°"><span></span></button>
    </div>
  </header>

  <main class="container">
    <!-- ë‚ ì§œ & ì¬ìƒ ì»¨íŠ¸ë¡¤ -->
    <div class="bar">
      <button id="prevDay" class="chip" aria-label="ì´ì „">â—€</button>
      <div id="dateText" class="chip">2025-08-24</div>
      <button id="playToggle" class="chip" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶</button>

      <button id="playAll" class="btn primary">ì „ì²´ ì¬ìƒ</button>
      <button id="stopAll" class="btn ghost">ì •ì§€</button>
      <button id="doneBtn" class="btn ok">ì˜¤ëŠ˜ë¶„ ì™„ë£Œ</button>

      <button id="viewFav" class="btn ghost">â˜… ì–´ë ¤ìš´ ë‹¨ì–´</button>
      <button id="viewLog" class="btn ghost">ê¸°ë¡</button>
    </div>

    <div class="bar">
      <label>ì†ë„ <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" class="range"></label>
      <select id="voiceSelect" class="sel" title="ì˜ì–´ ìŒì„± ì„ íƒ"></select>
    </div>

    <!-- ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ -->
    <section id="list"></section>
  </main>

  <!-- ì˜¤ë²„ë ˆì´ & ì‚¬ì´ë“œ ì‹œíŠ¸(ê³„ì •) -->
  <div id="overlay" class="overlay"></div>
  <aside id="sheet" class="sheet" aria-label="ê³„ì •">
    <h3>ê³„ì •</h3>
    <div id="signedOut">
      <div class="field"><input id="email" class="input" type="email" placeholder="you@example.com" autocomplete="username"></div>
      <div class="field"><input id="pw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" autocomplete="current-password"></div>
      <div class="field"><button id="loginBtn" class="btn primary full">ë¡œê·¸ì¸</button></div>
      <div class="field"><button id="signupBtn" class="btn ghost full">íšŒì›ê°€ì…</button></div>
      <div class="field"><button id="googleBtn" class="btn ghost full">Googleë¡œ ë¡œê·¸ì¸</button></div>
    </div>

    <div id="signedIn" style="display:none">
      <div class="card">
        <div class="row">
          <div class="num" id="meBadge">ìœ </div>
          <div style="flex:1">
            <div style="font-weight:800" id="meName">ë¡œê·¸ì¸ë¨</div>
            <div id="meMail" style="color:#64748b">-</div>
          </div>
        </div>
      </div>
      <button id="logoutBtn" class="btn warn full logout">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </aside>

  <!-- ë°ì´í„° & ë¡œì§ -->
  <script type="module">
    /***********************
     * 0) ìœ í‹¸
     ************************/
    const $ = (sel, el=document)=>el.querySelector(sel);
    const $$ = (sel, el=document)=>[...el.querySelectorAll(sel)];
    const fmt = (d)=>d.toISOString().slice(0,10);
    const todayStr = fmt(new Date());

    /***********************
     * 1) ìŠ¬ë¼ì´ë“œ íŒ¨ë„ ì œì–´
     ************************/
    const sheet = $('#sheet');
    const overlay = $('#overlay');
    const openSheet = () => { sheet.classList.add('open'); overlay.classList.add('show'); };
    const closeSheet = () => { sheet.classList.remove('open'); overlay.classList.remove('show'); };
    $('#accountBtn').addEventListener('click', openSheet);
    overlay.addEventListener('click', closeSheet);

    /***********************
     * 2) Firebase Auth
     *    (configë§Œ ë°”ê¿” ë„£ìœ¼ë©´ ë°”ë¡œ ë™ì‘)
     ************************/
    // ğŸ”§ Firebase ì„¤ì • (ë‹¹ì‹ ì˜ ì½˜ì†” ê°’ìœ¼ë¡œ êµì²´)
    const firebaseConfig = {
      apiKey: "AIzaSyBtN9HptAjl3wzemzKIr8nHvRHyOsvjsNI",
      authDomain: "voca-khw.firebaseapp.com",
      projectId: "voca-khw",
      storageBucket: "voca-khw.firebasestorage.app",
      messagingSenderId: "697341566223",
      appId: "1:697341566223:web:2a40f413b1edeb543c727a",
      measurementId: "G-Y5XZEX3W9X"
    };

    // CDN ëª¨ë“ˆ ì‚¬ìš©
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // UI ìš”ì†Œ
    const signedOut = $('#signedOut');
    const signedIn  = $('#signedIn');
    const meBadge   = $('#meBadge');
    const meName    = $('#meName');
    const meMail    = $('#meMail');

    // ìƒíƒœ ë³€í™”
    onAuthStateChanged(auth, (user)=>{
      if (user) {
        const name = user.displayName || (user.email ? user.email.split('@')[0] : 'ì‚¬ìš©ì');
        const mail = user.email || '';
        signedOut.style.display = 'none';
        signedIn.style.display  = 'block';
        meBadge.textContent = name[0]?.toUpperCase() || 'ìœ ';
        meName.textContent  = name;
        meMail.textContent  = mail;
      } else {
        signedOut.style.display = 'block';
        signedIn.style.display  = 'none';
      }
    });

    // ë¡œê·¸ì¸/ê°€ì…/êµ¬ê¸€/ë¡œê·¸ì•„ì›ƒ
    $('#loginBtn').addEventListener('click', async ()=>{
      const email = $('#email').value.trim();
      const pw    = $('#pw').value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, pw);
        closeSheet();
        alert('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch(e){ alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message); }
    });

    $('#signupBtn').addEventListener('click', async ()=>{
      const email = $('#email').value.trim();
      const pw    = $('#pw').value.trim();
      try {
        await createUserWithEmailAndPassword(auth, email, pw);
        closeSheet();
        alert('íšŒì›ê°€ì… ì™„ë£Œ!');
      } catch(e){ alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + e.message); }
    });

    $('#googleBtn').addEventListener('click', async ()=>{
      try {
        await signInWithPopup(auth, provider);
        closeSheet();
        alert('Google ë¡œê·¸ì¸ ì™„ë£Œ!');
      } catch(e){ alert('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message); }
    });

    $('#logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
      closeSheet();
      alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    /***********************
     * 3) ë‹¨ì–´ ë¡œë”© & ì¼ì ë¡œì§
     ************************/
    const dateText = $('#dateText');
    let currentDate = todayStr;
    dateText.textContent = currentDate;

    // ë‚ ì§œ ì´ë™
    $('#prevDay').addEventListener('click', ()=>{
      const d = new Date(currentDate); d.setDate(d.getDate()-1);
      currentDate = fmt(d); dateText.textContent = currentDate;
      renderWords();
    });

    $('#playToggle').addEventListener('click', ()=>{
      // ê°„ë‹¨ í† ê¸€(ì•„ì´ì½˜ë§Œ)
      const t = $('#playToggle'); t.textContent = t.textContent === 'â–¶' ? 'â¸' : 'â–¶';
    });

    // ì˜¤ëŠ˜ ì™„ë£Œ â†’ ë¡œê·¸ ê¸°ë¡ + ë‚´ì¼ ë‚ ì§œë¡œ ì´ë™
    $('#doneBtn').addEventListener('click', ()=>{
      const logs = JSON.parse(localStorage.getItem('studyLogs')||'[]');
      if (!logs.includes(currentDate)) logs.push(currentDate);
      localStorage.setItem('studyLogs', JSON.stringify(logs));
      const d = new Date(currentDate); d.setDate(d.getDate()+1);
      currentDate = fmt(d); dateText.textContent = currentDate;
      renderWords();
      alert('ì˜¤ëŠ˜ë¶„ ì™„ë£Œ! ë‹¤ìŒ ë‚ ì§œë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
    });

    // words.jsonì—ì„œ ë¡œë”© (GitHub Pages ë£¨íŠ¸ì— ìœ„ì¹˜)
    async function fetchWords(){
      const res = await fetch('./words.json', {cache:'no-cache'});
      return res.json(); // [{phrase, meaning, example}, ...]
    }

    /***********************
     * 4) ìŒì„± í•©ì„± (ì •í™•í•œ ì˜ì–´/í•œêµ­ì–´ ì„ íƒ)
     ************************/
    const voiceSelect = $('#voiceSelect');
    const rateInput   = $('#rate');
    let voices = [];

    function loadVoices(){
      voices = window.speechSynthesis.getVoices();
      // ì˜ì–´ ìŒì„±ë§Œ ë…¸ì¶œ (ëª…í™•í•œ ì˜ì–´ ë°œìŒ)
      const englishVoices = voices.filter(v => /^en(-|_)/i.test(v.lang));
      voiceSelect.innerHTML = englishVoices
        .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
      // ê¸°ë³¸ en-US ìš°ì„  ì„ íƒ
      const prefer = englishVoices.find(v=>/en[-_]US/i.test(v.lang)) || englishVoices[0];
      if (prefer) voiceSelect.value = prefer.name;
    }
    loadVoices();
    if (typeof speechSynthesis !== 'undefined') {
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speak(text, lang='en-US'){
      if (!text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = parseFloat(rateInput.value || '1');
      // ì„ íƒëœ ì˜ì–´ ìŒì„± ìš°ì„ 
      let voice = voices.find(v=>v.name === voiceSelect.value);
      if (!voice || !/^en(-|_)/i.test(voice.lang)) {
        // í˜¹ì‹œ í•œêµ­ì–´ê°€ ì„ íƒë¼ìˆìœ¼ë©´ en-USë¡œ ê°•ì œ
        voice = voices.find(v=>/en[-_]US/i.test(v.lang)) || voices.find(v=>/^en/i.test(v.lang));
      }
      if (voice) { utter.voice = voice; utter.lang = voice.lang; }
      else { utter.lang = lang; }
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    /***********************
     * 5) ë Œë”ë§
     ************************/
    const listEl = $('#list');
    let pool = [];

    function sliceByDate(all, dateStr){
      // ë‚ ì§œë¥¼ ê¸°ë°˜ìœ¼ë¡œ 10ê°œ ê³ ì • ìŠ¬ë¼ì´ì‹± (ì•ˆì •ì  ì¸ë±ì‹±)
      const seed = parseInt(dateStr.replaceAll('-',''),10);
      const start = Math.abs(seed) % Math.max(1, all.length-10);
      return all.slice(start, start+10);
    }

    async function renderWords(){
      if (pool.length === 0) pool = await fetchWords();
      const items = sliceByDate(pool, currentDate);
      listEl.innerHTML = '';
      items.forEach((w, idx)=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="row">
            <div class="num">${idx+1}</div>
            <div style="flex:1;min-width:0">
              <div class="word">${w.phrase}</div>
              <div class="mean">${w.meaning}</div>
              <div class="ex">ì˜ˆë¬¸: ${w.example || ''}</div>
            </div>
            <div class="row" style="gap:6px">
              <button class="tag en">EN</button>
              <button class="tag ko">KO</button>
              <button class="fav" title="ì–´ë ¤ìš´ ë‹¨ì–´ ë³´ê´€">â˜…</button>
            </div>
          </div>
        `;
        // ìŒì„± ë²„íŠ¼
        $('.en', card).addEventListener('click', ()=> speak(w.phrase, 'en-US'));
        $('.ko', card).addEventListener('click', ()=> {
          // í•œêµ­ì–´ ì„¤ëª…ì€ í•œêµ­ì–´ ìŒì„±ìœ¼ë¡œ
          const u = new SpeechSynthesisUtterance(w.meaning);
          u.lang = 'ko-KR'; u.rate = parseFloat(rateInput.value || '1');
          speechSynthesis.cancel(); speechSynthesis.speak(u);
        });
        // ì¦ê²¨ì°¾ê¸°(ì–´ë ¤ìš´ ë‹¨ì–´)
        $('.fav', card).addEventListener('click', ()=>{
          const favs = JSON.parse(localStorage.getItem('favs')||'[]');
          favs.push({...w, savedAt: Date.now()});
          localStorage.setItem('favs', JSON.stringify(favs));
          alert('ì–´ë ¤ìš´ ë‹¨ì–´ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
        });
        listEl.appendChild(card);
      });
    }

    // ë³´ê¸° í† ê¸€
    $('#viewFav').addEventListener('click', ()=>{
      const favs = JSON.parse(localStorage.getItem('favs')||'[]');
      if (favs.length===0) { alert('ì €ì¥ëœ ì–´ë ¤ìš´ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      listEl.innerHTML = '';
      favs.forEach((w,i)=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="row">
            <div class="num">â˜…</div>
            <div style="flex:1">
              <div class="word">${w.phrase}</div>
              <div class="mean">${w.meaning}</div>
              <div class="ex">ì˜ˆë¬¸: ${w.example || ''}</div>
            </div>
            <div class="row" style="gap:6px">
              <button class="tag en">EN</button>
              <button class="tag ko">KO</button>
            </div>
          </div>`;
        $('.en', card).addEventListener('click', ()=> speak(w.phrase,'en-US'));
        $('.ko', card).addEventListener('click', ()=>{
          const u = new SpeechSynthesisUtterance(w.meaning);
          u.lang='ko-KR'; u.rate=parseFloat(rateInput.value||'1');
          speechSynthesis.cancel(); speechSynthesis.speak(u);
        });
        listEl.appendChild(card);
      });
    });

    $('#viewLog').addEventListener('click', ()=>{
      const logs = JSON.parse(localStorage.getItem('studyLogs')||'[]');
      if (logs.length===0){ alert('í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      listEl.innerHTML = '';
      logs.sort().forEach((d,i)=>{
        const card = document.createElement('article');
        card.className='card';
        card.innerHTML = `<div class="row">
          <div class="num">âœ”</div>
          <div style="flex:1;font-weight:900">${d}</div>
          <button class="btn ghost">ì´ë‚  ë‹¨ì–´ ë³´ê¸°</button>
        </div>`;
        $('button',card).addEventListener('click', ()=>{
          currentDate = d; dateText.textContent = currentDate; renderWords();
          window.scrollTo({top:0,behavior:'smooth'});
        });
        listEl.appendChild(card);
      });
    });

    // ì „ì²´ ì¬ìƒ / ì •ì§€
    $('#playAll').addEventListener('click', async ()=>{
      const texts = [...$$('.word', listEl)].map(el=>el.textContent.trim()).filter(Boolean);
      for (const t of texts){
        speak(t,'en-US');
        // ëŒ€ëµ ê¸¸ì´ì— ë¹„ë¡€í•œ ëŒ€ê¸°
        await new Promise(r=>setTimeout(r, Math.max(800, t.length*90) / parseFloat(rateInput.value||'1')));
      }
    });
    $('#stopAll').addEventListener('click', ()=> speechSynthesis.cancel());

    // ì´ˆê¸° ë Œë”
    renderWords();
  </script>
</body>
</html>
