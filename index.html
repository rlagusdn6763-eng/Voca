<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜¤ëŠ˜ì˜ íšŒí™” ì˜ë‹¨ì–´</title>
  <style>
    :root{
      --bg:#f6faf9;
      --card:#ffffff;
      --text:#122022;
      --muted:#5f7b83;
      --primary:#0fb49a;
      --primary-cta:#13c7aa;
      --danger:#ef4444;
      --chip:#eaf7f4;
      --hard:#ffe9b0;
      --border:#e7efee;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,sans-serif;
      line-height:1.45;
    }
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    header{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between
    }
    h1{font-size:28px;margin:0;font-weight:800;letter-spacing:-.3px}
    .status-badge{
      display:inline-flex;align-items:center;gap:8px;background:#e8fbf2;color:#056c51;
      padding:8px 12px;border-radius:999px;font-weight:700;border:1px solid #c9f3e3
    }
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    button, .btn{
      appearance:none;border:1px solid var(--border);background:var(--card);
      padding:10px 14px;border-radius:12px;font-weight:700;color:var(--text);
      box-shadow:0 1px 0 rgba(0,0,0,.03);cursor:pointer
    }
    .btn-primary{background:var(--primary-cta);border-color:var(--primary-cta);color:#fff}
    .btn-ghost{background:transparent}
    .btn-danger{background:#fee2e2;border-color:#fecaca;color:#b91c1c}
    .btn-outline{background:#fff;border-color:var(--primary-cta);color:var(--primary-cta)}
    .date-nav{display:flex;align-items:center;gap:8px}
    .date-box{background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-weight:800}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 12px;
      display:flex;gap:12px;align-items:flex-start;position:relative
    }
    .idx{width:36px;height:36px;border-radius:10px;background:var(--chip);display:grid;place-items:center;font-weight:800;color:#0f6b5e}
    .word{font-weight:800;font-size:18px}
    .meaning{color:var(--muted);margin-top:2px}
    .ex{margin-top:6px;font-size:14px;color:#2b3d41}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f8fbfb;color:#284549}
    .hard{background:var(--hard);border-color:#ffd97a}
    .actions{margin-left:auto;display:flex;gap:8px}
    .muted{color:var(--muted)}
    .footer-tips{margin:18px 0;color:var(--muted);font-size:14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:#eef7ff;border:1px solid #d3ebff;color:#275b8a}
    .ok{color:var(--ok)}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(16,24,27,.4);display:none;place-items:center;padding:16px;z-index:50}
    .modal{max-width:520px;width:100%;background:#fff;border-radius:16px;border:1px solid var(--border);padding:16px 16px 12px}
    .modal h3{margin:4px 0 8px}
    .row{display:flex;gap:8px}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .link{color:#0e8e7a;text-decoration:underline;cursor:pointer}
    .history{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;font-size:14px}
    .pill{padding:4px 8px;border-radius:999px;background:#f0fdfa;color:#035e49;border:1px solid #c9f3e3;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ì˜¤ëŠ˜ì˜ íšŒí™” ì˜ë‹¨ì–´</h1>
      <span id="completeBadge" class="status-badge" hidden>âœ” ì˜¤ëŠ˜ë¶„ í•™ìŠµ ì™„ë£Œ</span>
    </header>

    <div class="topbar">
      <div class="date-nav">
        <button id="prevDay" class="btn">â—€</button>
        <div id="dateBox" class="date-box">--------</div>
        <button id="nextDay" class="btn">â–¶</button>
      </div>

      <div class="toolbar" style="margin-left:auto">
        <button id="btnPlayAll" class="btn btn-primary">ì „ì²´ ì¬ìƒ</button>
        <button id="btnStopAll" class="btn btn-outline">ì •ì§€</button>
        <button id="btnMarkDone" class="btn">ì˜¤ëŠ˜ë¶„ ì™„ë£Œ</button>
        <button id="btnLogin" class="btn">ë¡œê·¸ì¸</button>
        <button id="btnLogout" class="btn btn-ghost" hidden>ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="controls">
      <label class="muted">ì†ë„</label>
      <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" />
      <span id="rateVal" class="muted">1.0x</span>
    </div>

    <section id="list" class="grid" aria-live="polite"></section>

    <section class="history">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>í•™ìŠµ ê¸°ë¡</strong>
        <div class="row">
          <input id="filterDate" type="date" class="input" />
          <button id="btnClearFilter" class="btn">í•„í„° í•´ì œ</button>
        </div>
      </div>
      <table class="table" id="historyTable">
        <thead><tr><th>ë‚ ì§œ</th><th>ì™„ë£Œ</th><th>ë‹¨ì–´ ìˆ˜</th><th>ì–´ë ¤ìš´ ë‹¨ì–´</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <p class="footer-tips">ğŸ’¡ ë°œìŒì´ ì–´ìƒ‰í•˜ë©´ ë¸Œë¼ìš°ì €ì˜ TTS ìŒì„± ì„¤ì •ì—ì„œ <b>English(US/UK)</b>ì™€ <b>í•œêµ­ì–´</b> ìŒì„±ì„ ì„ íƒí•˜ì„¸ìš”.</p>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="modalBack" class="modal-back">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
        <button id="modalClose" class="btn">ë‹«ê¸°</button>
      </div>
      <p class="muted">ì´ë©”ì¼Â·ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ë˜ëŠ” Google ê³„ì •ìœ¼ë¡œ ê°„í¸ ë¡œê·¸ì¸</p>
      <input id="email" class="input" type="email" placeholder="ì´ë©”ì¼" />
      <div style="height:8px"></div>
      <input id="password" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" />
      <div style="height:8px"></div>
      <div class="row">
        <button id="doLogin" class="btn btn-outline" style="flex:1">ë¡œê·¸ì¸</button>
        <button id="doSignup" class="btn btn-primary" style="flex:1">íšŒì›ê°€ì…</button>
      </div>
      <div style="text-align:center;margin:8px 0" class="muted">ë˜ëŠ”</div>
      <button id="doGoogle" class="btn" style="width:100%">Googleë¡œ ë¡œê·¸ì¸</button>
    </div>
  </div>

  <script type="module">
    /******** Firebase (ëª¨ë“ˆ CDN) ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged,
             signInWithEmailAndPassword, createUserWithEmailAndPassword,
             GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtN9HptAjl3wzemzKIr8nHvRHyOsvjsNI",
      authDomain: "voca-khw.firebaseapp.com",
      projectId: "voca-khw",
      storageBucket: "voca-khw.firebasestorage.app",
      messagingSenderId: "697341566223",
      appId: "1:697341566223:web:2a40f413b1edeb543c727a",
      measurementId: "G-Y5XZEX3W9X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let db = null;
    try { db = getFirestore(app); } catch(e){ db = null; }

    /******** ì•± ìƒíƒœ ********/
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>root.querySelectorAll(s);
    const state = {
      user:null,
      words:[],
      hardSet:new Set(),
      todayKey:"",
      rate:1,
      playing:false
    };

    /******** ë‚ ì§œ/í‚¤ ********/
    const fmt = d=>d.toISOString().slice(0,10);
    let currentDate = new Date();
    function setDate(d){
      currentDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      $("#dateBox").textContent = fmt(currentDate);
      state.todayKey = fmt(currentDate);
      renderCompleteBadge();
      loadHistoryTable();
      loadWords();
    }

    $("#prevDay").onclick = ()=>setDate(new Date(currentDate.getTime()-86400000));
    $("#nextDay").onclick = ()=>setDate(new Date(currentDate.getTime()+86400000));
    $("#filterDate").onchange = loadHistoryTable;
    $("#btnClearFilter").onclick = ()=>{$("#filterDate").value=""; loadHistoryTable();};

    /******** words.json ë¶ˆëŸ¬ì˜¤ê¸° ********/
    async function loadWords(){
      try{
        const res = await fetch("./words.json?v="+Date.now());
        const data = await res.json(); // [{phrase, meaning, example?}, ...] 10ê°œ ì˜ˆìƒ
        state.words = Array.isArray(data) ? data : (data.words || []);
        // ê¸°ë¡ì˜ 'ì–´ë ¤ìš´ ë‹¨ì–´' í‘œì‹œ ë°˜ì˜
        const hard = getStore().hard?.[state.todayKey] || [];
        state.hardSet = new Set(hard);
        renderList();
      }catch(e){
        $("#list").innerHTML = `<div class="muted">ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${e}</div>`;
      }
    }

    /******** ë Œë”ë§ ********/
    function renderList(){
      const list = $("#list");
      list.innerHTML = "";
      state.words.forEach((w,i)=>{
        const card = document.createElement("div");
        card.className="card";
        if(state.hardSet.has(w.phrase)) card.style.outline="2px solid #ffd166";
        card.innerHTML = `
          <div class="idx">${i+1}</div>
          <div style="flex:1">
            <div class="word">${w.phrase}</div>
            <div class="meaning">${w.meaning ?? ""}</div>
            ${w.example ? `<div class="ex"><span class="chip tag">ì˜ˆë¬¸</span> ${w.example}</div>` : ""}
            <div class="chips">
              <span class="chip ${state.hardSet.has(w.phrase)?"hard":""}">ì–´ë ¤ìš´ ë‹¨ì–´</span>
            </div>
          </div>
          <div class="actions">
            <button class="btn speak-en">EN</button>
            <button class="btn speak-ko">KO</button>
            <button class="btn mark-hard">${state.hardSet.has(w.phrase)?"â˜…":"â˜†"}</button>
          </div>
        `;
        // ì´ë²¤íŠ¸
        $(".speak-en",card).onclick = ()=>speak(w.phrase,"en");
        $(".speak-ko",card).onclick = ()=>speak(w.meaning||"", "ko");
        $(".mark-hard",card).onclick = ()=>{
          if(state.hardSet.has(w.phrase)) state.hardSet.delete(w.phrase);
          else state.hardSet.add(w.phrase);
          saveHardToday();
          renderList();
        };
        list.appendChild(card);
      });
    }

    /******** ì¬ìƒ ********/
    $("#rate").oninput = (e)=>{ state.rate=+e.target.value; $("#rateVal").textContent=state.rate.toFixed(1)+"x";}
    $("#btnPlayAll").onclick = async ()=>{
      state.playing=true;
      for(const w of state.words){
        if(!state.playing) break;
        await speak(w.phrase,"en");
        if(!state.playing) break;
        await speak(w.meaning||"","ko");
      }
    };
    $("#btnStopAll").onclick = ()=>{ state.playing=false; speechSynthesis.cancel(); };

    function speak(text, lang){
      return new Promise(resolve=>{
        if(!text){ resolve(); return; }
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang==="en" ? "en-US" : "ko-KR";
        u.rate = state.rate;
        u.onend = ()=>setTimeout(resolve,120);
        u.onerror = ()=>resolve();
        speechSynthesis.cancel(); // ë²„íŠ¼ ì—°ì† í´ë¦­ ì‹œ ê²¹ì¹¨ ë°©ì§€
        speechSynthesis.speak(u);
      });
    }

    /******** ì™„ë£Œ/íˆìŠ¤í† ë¦¬ ********/
    $("#btnMarkDone").onclick = async ()=>{
      const store = getStore();
      store.done = store.done || {};
      store.done[state.todayKey] = true;
      store.count = store.count || {};
      store.count[state.todayKey] = state.words.length;
      store.hard = store.hard || {};
      store.hard[state.todayKey] = Array.from(state.hardSet);
      setStore(store);
      renderCompleteBadge();
      await saveRemoteProgress(store);
      loadHistoryTable();
      alert("ì˜¤ëŠ˜ë¶„ ì™„ë£Œë¡œ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì—´ë©´ ë‹¤ìŒ ë‹¨ì–´ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤!");
    };

    function renderCompleteBadge(){
      const done = !!getStore().done?.[state.todayKey];
      $("#completeBadge").hidden = !done;
    }

    function loadHistoryTable(){
      const tbody = $("#historyTable tbody");
      tbody.innerHTML = "";
      const store = getStore();
      const filter = $("#filterDate").value;
      const rows = Object.keys(store.done||{})
        .sort()
        .filter(d=>!filter || d===filter)
        .map(d=>({
          date:d,
          done: store.done[d],
          cnt: store.count?.[d] ?? 0,
          hard: (store.hard?.[d] ?? []).length
        }));
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td>
                        <td>${r.done?'<span class="pill">ì™„ë£Œ</span>':'-'}</td>
                        <td>${r.cnt}</td>
                        <td>${r.hard}</td>`;
        tbody.appendChild(tr);
      }
    }

    function saveHardToday(){
      const store=getStore();
      store.hard = store.hard || {};
      store.hard[state.todayKey] = Array.from(state.hardSet);
      setStore(store);
      saveRemoteProgress(store);
    }

    /******** ì €ì¥ì†Œ (Firestore â†” localStorage) ********/
    const LS_KEY = "voca-progress";
    const userDocRef = ()=> db && state.user ? doc(db,"users",state.user.uid) : null;

    function getStore(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw? JSON.parse(raw): {};
      }catch{return {}}
    }
    function setStore(obj){
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    async function saveRemoteProgress(store){
      const ref = userDocRef();
      if(!ref) return;
      try{
        await setDoc(ref,{progress:store, updatedAt:serverTimestamp()},{merge:true});
      }catch(e){ /* Firestore ë¹„í™œì„±ì‹œ ë¬´ì‹œ */ }
    }
    async function loadRemoteProgress(){
      const ref = userDocRef();
      if(!ref) return;
      try{
        const snap = await getDoc(ref);
        if(snap.exists()){
          const remote = snap.data().progress || {};
          // ë¡œì»¬ê³¼ ë³‘í•©(ì›ê²© ìš°ì„ )
          setStore({...getStore(), ...remote});
        }
      }catch(e){ /* ë¬´ì‹œ */ }
    }

    /******** ë¡œê·¸ì¸ UI ********/
    const modal = $("#modalBack");
    const openModal = ()=> modal.style.display="grid";
    const closeModal = ()=> modal.style.display="none";
    $("#btnLogin").onclick = openModal;
    $("#modalClose").onclick = closeModal;

    $("#doSignup").onclick = async ()=>{
      const email=$("#email").value.trim();
      const pw=$("#password").value.trim();
      try{
        await createUserWithEmailAndPassword(auth,email,pw);
        alert("íšŒì›ê°€ì… ì„±ê³µ!");
        closeModal();
      }catch(e){ alert("íšŒì›ê°€ì… ì‹¤íŒ¨: "+e); }
    };
    $("#doLogin").onclick = async ()=>{
      const email=$("#email").value.trim();
      const pw=$("#password").value.trim();
      try{
        await signInWithEmailAndPassword(auth,email,pw);
        alert("ë¡œê·¸ì¸ ì„±ê³µ!");
        closeModal();
      }catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e); }
    };
    $("#doGoogle").onclick = async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        alert("Google ë¡œê·¸ì¸ ì„±ê³µ!");
        closeModal();
      }catch(e){ alert("Google ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e); }
    };
    $("#btnLogout").onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      state.user = user || null;
      $("#btnLogin").hidden = !!user;
      $("#btnLogout").hidden = !user;
      if(user){
        await loadRemoteProgress();
        renderCompleteBadge();
        loadHistoryTable();
      }
    });

    /******** ì´ˆê¸°í™” ********/
    $("#rateVal").textContent = (+$("#rate").value).toFixed(1)+"x";
    setDate(new Date()); // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¡œë“œ
  </script>
</body>
</html>
