<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>오늘의 회화 영단어</title>
  <style>
    :root{
      --blue:#1664d9; --blue-dark:#0f49a8; --green:#23b26d; --red:#e24a43; --bg:#f5f7fb; --card:#ffffff;
      --text:#0f172a; --muted:#64748b; --ring:rgba(22,100,217,.14);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 64px}
    .appbar{position:sticky;top:0;z-index:40;background:linear-gradient(90deg,#1559c7,#1a6df3);color:#fff}
    .appbar-inner{max-width:980px;margin:0 auto;padding:16px 14px;display:flex;align-items:center;gap:12px}
    .title{font-weight:800;font-size:22px;letter-spacing:-.3px}
    .spacer{flex:1}
    .icon-btn{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:rgba(255,255,255,.15);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.25);cursor:pointer}
    .icon{width:22px;height:22px;display:block}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:14px 0}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:var(--text);font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .btn:active{transform:translateY(1px)}
    .btn.pri{background:var(--green);border-color:var(--green);color:#fff}
    .btn.ghost{background:#fff}
    .btn.warn{background:var(--red);border-color:var(--red);color:#fff}
    .chip{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
    .datebar{display:grid;grid-template-columns:44px 1fr 44px;gap:10px;align-items:center;margin:12px 0}
    .datebox{height:48px;border-radius:12px;display:grid;place-items:center;background:#fff;border:1px solid #e5e7eb;font-weight:800;font-size:18px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .list{display:grid;gap:12px;margin-top:8px}
    .card{background:var(--card);border:1px solid #e7eaf1;border-radius:16px;padding:16px;box-shadow:0 2px 0 rgba(22,100,217,.03)}
    .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .idx{min-width:28px;height:28px;border-radius:999px;background:#eef4ff;color:#1e40af;display:grid;place-items:center;font-weight:800}
    .ph{font-weight:900;font-size:20px;letter-spacing:.2px}
    .ko{color:var(--muted);margin-top:4px}
    .ex{margin-top:8px;color:#0f172a}
    .pill{display:flex;gap:8px;margin-top:10px}
    .pill .mini{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800}
    .star{width:40px;height:40px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;display:grid;place-items:center;cursor:pointer}
    .star.on{background:#fff7e6;border-color:#ffd699}
    /* speed + voice */
    .controls{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:16px 0}
    .slider{accent-color:var(--blue);width:100%}
    .select{height:44px;border:1px solid #e5e7eb;border-radius:12px;padding:0 12px;background:#fff}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.32);z-index:60}
    .modal.show{display:flex}
    .sheet{width:min(680px,92vw);background:#fff;border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.2);border:1px solid #e7eaf1}
    .sheet-h{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #eef2f7}
    .sheet-b{padding:18px}
    .muted{color:var(--muted)}
    .q{font-weight:800;font-size:22px;line-height:1.35}
    .choice{display:block;width:100%;text-align:left;margin:8px 0;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:700;cursor:pointer}
    .choice.correct{border-color:#22c55e;background:#ecfdf5}
    .choice.wrong{border-color:#ef4444;background:#fef2f2}
    .foot{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    /* side account panel trigger (… button is in header) */
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    @media (max-width:420px){
      .title{font-size:18px}
      .datebox{font-size:16px}
      .btn{padding:10px 12px}
      .ph{font-size:18px}
    }
  </style>
</head>
<body>
  <!-- AppBar -->
  <header class="appbar">
    <div class="appbar-inner">
      <div class="title">오늘의 회화 영단어</div>
      <div class="spacer"></div>
      <button id="btnAccount" class="icon-btn" aria-label="계정 / 설정 열기" title="계정">
        <svg class="icon" viewBox="0 0 24 24" fill="#fff"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
      </button>
    </div>
  </header>

  <main class="wrap">
    <!-- 날짜 이동 -->
    <div class="datebar">
      <button class="datebox" id="prevDay" aria-label="이전 날짜">◀</button>
      <div class="datebox" id="dateLabel">YYYY-MM-DD</div>
      <button class="datebox" id="nextDay" aria-label="다음 날짜">▶</button>
    </div>

    <!-- 상단 컨트롤 -->
    <div class="toolbar">
      <button class="btn ghost" id="playAll">전체 재생</button>
      <button class="btn ghost" id="stopAll">정지</button>
      <button class="btn pri" id="doneToday">오늘분 완료</button>
      <button class="btn ghost" id="btnToday">오늘의 단어</button>
      <button class="btn ghost" id="btnFav">★ 어려운 단어</button>
      <button class="btn ghost" id="btnLog">기록</button>
      <button class="btn warn" id="btnLogDelete">기록 삭제</button>
    </div>

    <!-- 속도 & TTS -->
    <div class="controls">
      <div>
        <div class="muted" style="font-weight:700">속도</div>
        <input type="range" id="speed" class="slider" min="0.7" max="1.4" step="0.1" value="1.0"/>
      </div>
      <select id="voiceSelect" class="select" title="영어 음성 선택">
        <option value="">영어 음성</option>
      </select>
    </div>

    <!-- 단어 리스트 -->
    <section id="list" class="list" aria-live="polite"></section>
  </main>

  <!-- 학습 모달 -->
  <div id="studyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="studyTitle">
    <div class="sheet">
      <div class="sheet-h">
        <div id="studyTitle" class="title">학습</div>
        <button id="studyClose" class="icon-btn" aria-label="닫기">
          <svg class="icon" viewBox="0 0 24 24" fill="#111"><path d="M6.4 4.9 4.9 6.4 10.5 12 4.9 17.6 6.4 19.1 12 13.5 17.6 19.1 19.1 17.6 13.5 12 19.1 6.4 17.6 4.9 12 10.5z"/></svg>
        </button>
      </div>
      <div class="sheet-b">
        <div class="muted" style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
          <span id="studyProgress" class="chip">1 / 10</span>
          <span id="studyScore" class="chip">정답 0</span>
          <span id="studyMode" class="chip">모드: 예문 빈칸</span>
        </div>
        <div id="studyQuestion" class="q">문제가 여기에</div>
        <div class="muted" style="margin:8px 0 14px">보기에서 정답을 고르세요.</div>
        <div id="choices"></div>
        <div class="foot">
          <button class="btn ghost" id="btnModeToggle">모드 전환</button>
          <button class="btn pri" id="btnNext">다음</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 계정 패널(간단 표기만) -->
  <div id="accountPanel" class="modal" aria-modal="true">
    <div class="sheet" style="width:min(420px,92vw)">
      <div class="sheet-h">
        <div class="title">계정</div>
        <button id="accountClose" class="icon-btn" aria-label="닫기">
          <svg class="icon" viewBox="0 0 24 24" fill="#111"><path d="M6.4 4.9 4.9 6.4 10.5 12 4.9 17.6 6.4 19.1 12 13.5 17.6 19.1 19.1 17.6 13.5 12 19.1 6.4 17.6 4.9 12 10.5z"/></svg>
        </button>
      </div>
      <div class="sheet-b">
        <div class="card">
          <div class="muted">로그인: 로컬(데모)</div>
          <div id="whoami" style="font-weight:800;margin-top:6px">게스트</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * 유틸/상태
     **********************/
    const $ = (q, el=document)=>el.querySelector(q);
    const $$ = (q, el=document)=>el.querySelectorAll(q);
    const fmt = (d)=>d.toISOString().slice(0,10);
    const todayStr = ()=>fmt(new Date());
    const st = {
      date: todayStr(),
      words: [],
      voices: [],
      playing: false,
      favs: JSON.parse(localStorage.getItem('favs')||'[]'),     // phrase 배열
      logs: JSON.parse(localStorage.getItem('logs')||'{}'),     // { 'YYYY-MM-DD': ['make do with', ...] }
    };

    function setDate(dstr){
      st.date = dstr;
      $('#dateLabel').textContent = dstr;
      loadForDate(dstr);
    }

    // words.json에서 해당 날짜 10개 가져오기(간단 로컬 샘플/ words.json은 기존 로직 유지)
    async function loadForDate(dstr){
      try{
        const res = await fetch('words.json',{cache:'no-store'});
        const all = await res.json();
        // words.json은 날짜별 배열 구조라고 가정: { "2025-08-24":[...10], ... }
        st.words = all[dstr] || [];
        renderList();
      }catch(e){
        console.error(e);
        st.words = [];
        renderList();
      }
    }

    /**********************
     * 렌더링
     **********************/
    function renderList(){
      const wrap = $('#list');
      wrap.innerHTML = '';
      if(!st.words.length){
        wrap.innerHTML = `<div class="card muted">여기에 단어 리스트 / 날짜 선택 등이 들어갑니다…</div>`;
        return;
      }
      st.words.forEach((w,i)=>{
        const card = document.createElement('article');
        card.className='card';

        const top = document.createElement('div');
        top.className='row';
        top.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <div class="idx">${i+1}</div>
            <div>
              <div class="ph">${w.phrase}</div>
              <div class="ko">${w.meaning||''}</div>
            </div>
          </div>
          <div class="star ${st.favs.includes(w.phrase)?'on':''}" data-phrase="${w.phrase}" title="어려운 단어">
            ★
          </div>
        `;
        card.appendChild(top);

        const ex = document.createElement('div');
        ex.className='ex';
        ex.textContent = `예문: ${w.example||''}`;
        card.appendChild(ex);

        const pill = document.createElement('div');
        pill.className='pill';
        const en = document.createElement('button');
        en.className='mini'; en.textContent='EN';
        en.onclick = ()=>speak(w.phrase,'en');
        const ko = document.createElement('button');
        ko.className='mini'; ko.textContent='KO';
        ko.onclick = ()=>speak(w.meaning||'','ko');
        const quiz1 = document.createElement('button');
        quiz1.className='mini'; quiz1.textContent='학습(뜻 맞추기)';
        quiz1.onclick = ()=>startStudy('meaning');
        const quiz2 = document.createElement('button');
        quiz2.className='mini'; quiz2.textContent='학습(예문 빈칸)';
        quiz2.onclick = ()=>startStudy('cloze');
        pill.append(en,ko,quiz1,quiz2);
        card.appendChild(pill);

        wrap.appendChild(card);
      });

      // 즐겨찾기 토글
      $$('.star').forEach(el=>{
        el.onclick = ()=>{
          const p = el.dataset.phrase;
          const i = st.favs.indexOf(p);
          if(i>=0){ st.favs.splice(i,1); el.classList.remove('on'); }
          else{ st.favs.push(p); el.classList.add('on'); }
          localStorage.setItem('favs',JSON.stringify(st.favs));
        };
      });
    }

    /**********************
     * 음성(TTS)
     **********************/
    function loadVoices(){
      const vs = speechSynthesis.getVoices();
      st.voices = vs.filter(v => /^en(-|_|$)/i.test(v.lang));
      const sel = $('#voiceSelect');
      sel.innerHTML = `<option value="">영어 음성</option>` + st.voices.map((v,i)=>`<option value="${i}">${v.name} (${v.lang})</option>`).join('');
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function speak(text, lang='en'){
      if(!text) return;
      try{ window.speechSynthesis.cancel(); }catch{}
      const u = new SpeechSynthesisUtterance(text);
      u.rate = parseFloat($('#speed').value||'1.0');
      if(lang==='en' && st.voices.length){
        const sel = $('#voiceSelect').value;
        if(sel !== '') u.voice = st.voices[Number(sel)] || st.voices[0];
        else u.voice = st.voices[0];
      }else if(lang==='ko'){
        // 한국어는 기본 한국어 음성 자동
        const ko = speechSynthesis.getVoices().find(v=>/^ko/i.test(v.lang));
        if(ko) u.voice = ko;
      }
      speechSynthesis.speak(u);
    }

    async function playAllSeq(){
      if(!st.words.length) return;
      st.playing = true;
      for(const w of st.words){
        if(!st.playing) break;
        speak(w.phrase,'en');
        await waitSpeak();
        if(!st.playing) break;
        speak(w.meaning||'','ko');
        await waitSpeak();
      }
      st.playing = false;
    }
    function waitSpeak(){
      return new Promise(res=>{
        const t = setInterval(()=>{
          if(!speechSynthesis.speaking){ clearInterval(t); res(); }
        },120);
      });
    }

    /**********************
     * 학습(뜻/클로즈)
     **********************/
    let study = { idx:0, score:0, mode:'cloze', bank:[] };

    function startStudy(mode='cloze'){
      study.mode = mode;
      study.idx = 0; study.score = 0;
      // 현재 날짜 단어 10개로 출제
      study.bank = st.words.slice(0,10);
      if(!study.bank.length){ alert('출제할 단어가 없습니다.'); return; }
      $('#studyMode').textContent = '모드: ' + (mode==='cloze' ? '예문 빈칸' : '단어 → 뜻');
      $('#studyModal').classList.add('show');
      nextQ(false);
    }

    function nextQ(increase=true){
      if(increase) study.idx++;
      if(study.idx>=study.bank.length){
        $('#studyQuestion').innerHTML = `학습 종료! 점수: <b>${study.score}</b> / ${study.bank.length}`;
        $('#choices').innerHTML = '';
        $('#studyProgress').textContent = `${study.bank.length} / ${study.bank.length}`;
        return;
      }
      $('#studyProgress').textContent = `${study.idx+1} / ${study.bank.length}`;
      $('#studyScore').textContent = `정답 ${study.score}`;
      const w = study.bank[study.idx];

      if(study.mode==='meaning'){
        // Q: phrase → 보기: 뜻 4지선다
        $('#studyQuestion').textContent = w.phrase;
        const opts = shuffle(pickMeanings(w.meaning));
        renderChoices(opts, w.meaning);
      }else{
        // Q: 예문 빈칸 → 보기: phrase 4지선다
        $('#studyQuestion').textContent = makeCloze(w);
        const opts = shuffle(pickPhrases(w.phrase));
        renderChoices(opts, w.phrase);
      }
    }

    // ***** 핵심 수정: 예문에서 해당 구를 '_____' 로 치환 *****
    function makeCloze(w){
      const ex = w.example || '';
      const p = (w.phrase||'').trim();
      if(!ex) return '_____';
      // phrase를 정규식으로 escape 후 대소문자 무시 치환
      const re = new RegExp(p.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'ig');
      let replaced = ex.replace(re,'_____');
      // 혹시 치환 실패하면 첫 단어를 빈칸 처리(문제 진행 보호)
      if(replaced === ex) replaced = ex.replace(/(^|\s)\S+/, ' _____');
      return replaced;
    }

    function pickPhrases(answer){
      const pool = st.words.map(x=>x.phrase).filter(Boolean);
      const wrongs = shuffle(pool.filter(p=>p!==answer)).slice(0,3);
      return shuffle([answer,...wrongs]);
    }
    function pickMeanings(answer){
      const pool = st.words.map(x=>x.meaning).filter(Boolean);
      const wrongs = shuffle(pool.filter(m=>m!==answer)).slice(0,3);
      return shuffle([answer,...wrongs]);
    }
    function renderChoices(options, answer){
      const box = $('#choices'); box.innerHTML='';
      options.forEach(opt=>{
        const b = document.createElement('button');
        b.className='choice';
        b.textContent = opt;
        b.onclick = ()=>{
          if(b.dataset.lock) return;
          const correct = opt === answer;
          b.classList.add(correct?'correct':'wrong');
          if(correct) study.score++;
          // 잠깐 대기 후 다음
          setTimeout(()=>nextQ(true), 420);
          // 잠금
          $$('.choice').forEach(x=>x.dataset.lock='1');
        };
        box.appendChild(b);
      });
    }
    function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }

    /**********************
     * 기록/완료
     **********************/
    $('#doneToday').onclick = ()=>{
      // 오늘분 완료 → 로그에 저장
      if(st.words.length){
        st.logs[st.date] = st.words.map(w=>w.phrase);
        localStorage.setItem('logs',JSON.stringify(st.logs));
        alert('저장됨! 완료 기록에 반영되었습니다.');
      }
    };

    /**********************
     * 이벤트
     **********************/
    $('#playAll').onclick = playAllSeq;
    $('#stopAll').onclick = ()=>{ st.playing=false; speechSynthesis.cancel(); };
    $('#btnToday').onclick = ()=>setDate(todayStr());

    $('#prevDay').onclick = ()=>{ const d=new Date(st.date); d.setDate(d.getDate()-1); setDate(fmt(d)); };
    $('#nextDay').onclick = ()=>{ const d=new Date(st.date); d.setDate(d.getDate()+1); setDate(fmt(d)); };

    $('#btnModeToggle').onclick = ()=>{
      study.mode = (study.mode==='cloze'?'meaning':'cloze');
      $('#studyMode').textContent = '모드: ' + (study.mode==='cloze' ? '예문 빈칸' : '단어 → 뜻');
      // 같은 인덱스로 다시 문제 리렌더
      study.idx = Math.max(0, study.idx);
      nextQ(false);
    };
    $('#btnNext').onclick = ()=>nextQ(true);
    $('#studyClose').onclick = ()=>$('#studyModal').classList.remove('show');

    $('#btnFav').onclick = ()=>{
      if(!st.favs.length){ alert('표시할 즐겨찾기가 없습니다.'); return; }
      const only = st.words.filter(w=>st.favs.includes(w.phrase));
      if(!only.length){ alert('현재 날짜의 단어 중 즐겨찾기가 없습니다.'); return; }
      const bak = st.words;
      st.words = only; renderList();
      setTimeout(()=>{ st.words = bak; }, 2000);
    };

    // 간단한 기록 보기/삭제(토스트 대용)
    $('#btnLog').onclick = ()=>{
      const keys = Object.keys(st.logs).sort();
      if(!keys.length){ alert('기록이 없습니다.'); return; }
      const msg = keys.map(k=>`${k}: ${st.logs[k].length}개`).join('\n');
      alert(msg);
    };

    $('#btnLogDelete').onclick = ()=>{
      const d = prompt('삭제할 날짜(YYYY-MM-DD)를 입력하세요');
      if(!d) return;
      if(st.logs[d]){ delete st.logs[d]; localStorage.setItem('logs',JSON.stringify(st.logs)); alert('삭제되었습니다.'); }
      else alert('해당 날짜 기록이 없습니다.');
    };

    // 계정 패널
    $('#btnAccount').onclick = ()=>$('#accountPanel').classList.add('show');
    $('#accountClose').onclick = ()=>$('#accountPanel').classList.remove('show');

    /**********************
     * 부트
     **********************/
    (async ()=>{
      $('#dateLabel').textContent = st.date;
      loadVoices();
      await loadForDate(st.date);
      $('#whoami').textContent = '게스트 모드';
    })();
  </script>
</body>
</html>
