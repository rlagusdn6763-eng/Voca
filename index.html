<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>오늘의 회화 영단어</title>
  <style>
    :root{
      --blue:#1e56a0;
      --blue-dark:#18447f;
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#606b85;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "맑은 고딕", "돋움", Dotum, sans-serif;
    }

    /* 헤더 */
    header{
      position:sticky; top:0; z-index:100;
      background:var(--blue);
      color:#fff;
      padding:16px 20px;
      box-shadow:var(--shadow);
    }
    .header-inner{
      max-width:960px;
      margin:0 auto;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .title{
      font-weight:800;
      font-size:20px;
      letter-spacing:.2px;
    }
    /* ● 버튼 – 제목 줄 오른쪽 상단 고정 */
    #menuToggle{
      position:absolute; right:0; top:50%; transform:translateY(-50%);
      width:36px; height:36px; border-radius:999px;
      border:none; outline:none; cursor:pointer;
      background:#fff; color:var(--blue);
      font-size:18px; font-weight:900;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    /* 메인 */
    main{max-width:960px; margin:20px auto; padding:0 16px}

    .toolbar{
      display:grid; grid-template-columns:1fr auto auto; gap:12px;
      align-items:center; margin-bottom:14px;
    }
    .date-wrap{
      display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .chip{
      background:#fff; border:1px solid #e6ebf5;
      border-radius:999px; height:40px; padding:0 14px;
      display:inline-flex; align-items:center; gap:8px;
      font-weight:700;
      box-shadow:var(--shadow);
    }
    .btn{
      background:#fff; border:1px solid #e6ebf5;
      border-radius:999px; height:40px; padding:0 16px;
      font-weight:700; cursor:pointer;
      box-shadow:var(--shadow);
    }
    .btn.primary{background:var(--blue); color:#fff; border:none}
    .btn.stop{background:#fff3f3; color:#b42318; border:1px solid #ffd3d3}
    .btn:active{transform:translateY(1px)}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0 18px}
    .row .group{
      background:#fff; border:1px solid #e6ebf5; border-radius:12px;
      padding:10px 12px; display:flex; gap:12px; align-items:center;
      box-shadow:var(--shadow);
    }
    .label{font-size:14px; color:var(--muted); font-weight:700}

    select, input[type="range"]{
      height:36px; border-radius:10px; border:1px solid #e6ebf5; padding:0 10px;
      background:#fff;
    }
    input[type="range"]{height:auto}

    /* 카드 */
    .card{
      background:var(--card);
      border:1px solid #ecf0f7;
      border-radius:var(--radius);
      padding:16px 14px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .card .head{
      display:flex; align-items:center; gap:10px; margin-bottom:6px
    }
    .idx{
      width:28px; height:28px; border-radius:9px;
      background:#eef3ff; color:var(--blue); font-weight:800;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .phrase{font-weight:800; font-size:18px}
    .meaning{color:#334155; margin:.25rem 0 .5rem}
    .ex{color:#6b7280; font-size:14px}
    .actions{margin-top:10px; display:flex; gap:8px; align-items:center}
    .pill{height:34px; padding:0 12px; border-radius:999px; border:1px solid #e6ebf5; background:#fff; font-weight:700; cursor:pointer}
    .star{margin-left:auto; height:34px; width:34px; border-radius:10px; border:1px solid #ffe1a3; background:#fff8e1; cursor:pointer}
    .star.active{background:#ffecb3}

    /* 슬라이드 패널 */
    #overlay{
      position:fixed; inset:0; background:rgba(2,6,23,.35);
      opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:1200;
    }
    #overlay.active{opacity:1; pointer-events:auto}
    #panel{
      position:fixed; top:0; right:-340px; width:320px; height:100%;
      background:#fff; box-shadow:-10px 0 24px rgba(0,0,0,.18);
      transition:right .25s ease; z-index:1300; padding:18px;
      display:flex; flex-direction:column; gap:12px;
    }
    #panel.active{right:0}
    .panel-title{font-size:18px; font-weight:800; margin-bottom:4px}
    .field{display:flex; flex-direction:column; gap:6px}
    .input{height:40px; border-radius:10px; border:1px solid #e6ebf5; padding:0 12px}
    .panel-btn{height:42px; border-radius:10px; border:none; font-weight:800; cursor:pointer}
    .panel-btn.primary{background:var(--blue); color:#fff}
    .panel-btn.ghost{background:#f1f5ff; color:var(--blue)}
    .profile{
      display:flex; gap:10px; align-items:center; background:#f8fafc; border:1px solid #eef2f7;
      padding:10px; border-radius:12px; margin-bottom:6px
    }
    .avatar{
      width:36px; height:36px; border-radius:12px; background:var(--blue); color:#fff;
      display:inline-flex; align-items:center; justify-content:center; font-weight:900
    }
    .ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    @media (max-width:420px){
      .phrase{font-size:17px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="title">오늘의 회화 영단어</div>
      <!-- 제목 줄 오른쪽 상단 고정 버튼 -->
      <button id="menuToggle" aria-label="사용자">●</button>
    </div>
  </header>

  <main>
    <!-- 상단 툴바 -->
    <div class="toolbar">
      <div class="date-wrap">
        <button class="btn" id="prevDay" title="이전 날짜">◀</button>
        <div class="chip"><span id="dateText">YYYY-MM-DD</span></div>
        <button class="btn" id="playAll" title="전체 재생">▶</button>
      </div>
      <button class="btn stop" id="stopAll">정지</button>
      <button class="btn primary" id="completeToday">오늘분 완료</button>
    </div>

    <!-- 재생 옵션 -->
    <div class="row">
      <div class="group">
        <span class="label">속도</span>
        <input id="rate" type="range" min="0.6" max="1.6" step="0.1" value="1.0"/>
        <span id="rateVal">1.0x</span>
      </div>

      <div class="group">
        <span class="label">영어 음성</span>
        <select id="enVoice"></select>
      </div>

      <div class="group">
        <span class="label">한국어 음성</span>
        <select id="koVoice"></select>
      </div>
    </div>

    <!-- 단어 목록 -->
    <div id="list"></div>
  </main>

  <!-- 어두운 배경 & 패널 -->
  <div id="overlay"></div>
  <aside id="panel" aria-hidden="true">
    <div class="panel-title">계정</div>
    <!-- 로그인 후 보이는 섹션 -->
    <div id="profileBox" style="display:none">
      <div class="profile">
        <div class="avatar" id="profileInitial">유</div>
        <div style="min-width:0">
          <div class="ellipsis" id="profileName" style="font-weight:800">홍길동</div>
          <div class="ellipsis" id="profileEmail" style="color:var(--muted)">you@example.com</div>
        </div>
      </div>
      <button class="panel-btn ghost" id="logoutBtn">로그아웃</button>
    </div>

    <!-- 로그인 폼 (예시, 실제 인증 로직은 Firebase에 연결해서 사용) -->
    <div id="loginBox">
      <div class="field">
        <label for="email">이메일</label>
        <input class="input" id="email" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <label for="pw">비밀번호</label>
        <input class="input" id="pw" type="password" placeholder="8자리 이상"/>
      </div>
      <button class="panel-btn primary" id="loginBtn">로그인</button>
      <button class="panel-btn ghost" id="signupBtn">회원가입</button>
    </div>
  </aside>

  <script>
    // ===== 날짜 표기 =====
    const dateText = document.getElementById('dateText');
    const todayKey = new Date().toISOString().slice(0,10);
    let currentKey = todayKey;
    function renderDate(){ dateText.textContent = currentKey; }
    renderDate();

    // ===== TTS 음성 준비 (영어/한국어 분리) =====
    const rate = document.getElementById('rate');
    const rateVal = document.getElementById('rateVal');
    const enVoiceSel = document.getElementById('enVoice');
    const koVoiceSel = document.getElementById('koVoice');
    let voices = [];
    let enVoices = [];
    let koVoices = [];

    function loadVoices(){
      voices = window.speechSynthesis.getVoices();
      enVoices = voices.filter(v => (v.lang || '').toLowerCase().startsWith('en'));
      koVoices = voices.filter(v => (v.lang || '').toLowerCase().startsWith('ko'));

      // 채우기
      function fill(select, items, fallback){
        const prev = select.value;
        select.innerHTML = items.map(v => {
          const lab = `${v.name} (${v.lang})${v.default ? ' • 기본' : ''}`;
          return `<option value="${v.name}">${lab}</option>`;
        }).join('') || `<option value="">(기기에서 ${fallback} 음성을 찾을 수 없음)</option>`;
        // 기본 선택
        const match = items.find(v => v.default) || items[0];
        if (match) select.value = match.name;
        if (prev && items.find(v => v.name === prev)) select.value = prev;
      }

      fill(enVoiceSel, enVoices, '영어');
      fill(koVoiceSel, koVoices, '한국어');
    }

    window.speechSynthesis.onvoiceschanged = loadVoices;
    // iOS 등에서 즉시 목록이 없을 수 있어 한 번 호출
    setTimeout(loadVoices, 200);

    rate.addEventListener('input', () => rateVal.textContent = `${Number(rate.value).toFixed(1)}x`);

    function getVoiceByName(name){
      return voices.find(v => v.name === name);
    }
    function pickEnVoice(){ return getVoiceByName(enVoiceSel.value) || enVoices[0]; }
    function pickKoVoice(){ return getVoiceByName(koVoiceSel.value) || koVoices[0]; }

    // ===== 단어 로드 & 렌더 =====
    const list = document.getElementById('list');
    let words = [];
    async function loadWords(){
      try{
        const res = await fetch('words.json', {cache:'no-store'});
        words = await res.json();
        renderWords();
      }catch(e){
        list.innerHTML = `<div class="card">단어를 불러오지 못했습니다. (${e})</div>`;
      }
    }
    loadWords();

    function renderWords(){
      list.innerHTML = '';
      words.forEach((w, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="head">
            <div class="idx">${i+1}</div>
            <div class="phrase">${w.phrase}</div>
          </div>
          <div class="meaning">${w.meaning}</div>
          ${w.example ? `<div class="ex">예문: ${w.example}</div>`:''}
          <div class="actions">
            <button class="pill en">EN</button>
            <button class="pill ko">KO</button>
            <button class="star" title="어려운 단어">★</button>
          </div>
        `;
        // 버튼 동작
        card.querySelector('.en').addEventListener('click', () => speakText(w.phrase, 'en'));
        card.querySelector('.ko').addEventListener('click', () => speakText(w.meaning, 'ko'));
        card.querySelector('.star').addEventListener('click', (ev) => {
          ev.currentTarget.classList.toggle('active');
          toggleHard(w);
        });
        list.appendChild(card);
      });
    }

    // ===== 재생 로직 (영/한 음성 강제 고정) =====
    let queue = [];
    let playing = false;

    function speakText(text, langMode='en'){
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = Number(rate.value);
      if(langMode === 'en'){
        const v = pickEnVoice();
        if (v){ utter.voice = v; utter.lang = v.lang; } else { utter.lang = 'en-US'; }
      }else{
        const v = pickKoVoice();
        if (v){ utter.voice = v; utter.lang = v.lang; } else { utter.lang = 'ko-KR'; }
      }
      window.speechSynthesis.speak(utter);
      return utter;
    }

    async function playAllWords(){
      if(playing){ return; }
      playing = true;
      queue = [];
      // EN -> KO 순차 재생
      words.forEach(w => {
        queue.push(()=>speakText(w.phrase,'en'));
        queue.push(()=>speakText(w.meaning,'ko'));
      });

      // 순차 처리
      while(queue.length && playing){
        const job = queue.shift();
        const u = job();
        await new Promise(resolve=>{
          u.onend = resolve;
          u.onerror = resolve;
        });
      }
      playing = false;
    }

    function stopAll(){
      playing = false;
      queue = [];
      window.speechSynthesis.cancel();
    }

    document.getElementById('playAll').addEventListener('click', playAllWords);
    document.getElementById('stopAll').addEventListener('click', stopAll);

    // ===== 어려운 단어(로컬 저장) =====
    const HARD_KEY = 'voca-hard';
    function getHard(){
      try{ return JSON.parse(localStorage.getItem(HARD_KEY)||'[]'); }catch{ return []; }
    }
    function setHard(arr){
      localStorage.setItem(HARD_KEY, JSON.stringify(arr));
    }
    function toggleHard(item){
      const cur = getHard();
      const idx = cur.findIndex(x=>x.phrase===item.phrase);
      if(idx>=0){ cur.splice(idx,1); } else { cur.push(item); }
      setHard(cur);
    }

    // ===== 날짜 이동 (UI만) =====
    document.getElementById('prevDay').addEventListener('click', ()=>{
      const d = new Date(currentKey);
      d.setDate(d.getDate()-1);
      currentKey = d.toISOString().slice(0,10);
      renderDate();
    });

    // ===== 오늘분 완료 (기록 예시) =====
    document.getElementById('completeToday').addEventListener('click', ()=>{
      const done = JSON.parse(localStorage.getItem('voca-done')||'{}');
      done[currentKey] = {count: words.length, at: Date.now()};
      localStorage.setItem('voca-done', JSON.stringify(done));
      alert('오늘분 완료로 기록했습니다!');
    });

    // ===== 패널 열고닫기 (바깥 클릭 / ESC 닫힘 포함) =====
    const toggleBtn = document.getElementById('menuToggle');
    const overlay = document.getElementById('overlay');
    const panel = document.getElementById('panel');
    function openPanel(){ overlay.classList.add('active'); panel.classList.add('active'); panel.setAttribute('aria-hidden','false'); }
    function closePanel(){ overlay.classList.remove('active'); panel.classList.remove('active'); panel.setAttribute('aria-hidden','true'); }
    toggleBtn.addEventListener('click', openPanel);
    overlay.addEventListener('click', closePanel);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });

    // ===== 가짜 로그인 데모 (UI만 동작) =====
    const loginBox = document.getElementById('loginBox');
    const profileBox = document.getElementById('profileBox');
    const profileInitial = document.getElementById('profileInitial');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');

    const DEMO_KEY = 'voca-demo-user';
    function loadUser(){
      try{
        const u = JSON.parse(localStorage.getItem(DEMO_KEY)||'null');
        if(u){
          loginBox.style.display='none';
          profileBox.style.display='';
          profileInitial.textContent = (u.name||'유저').slice(0,1);
          profileName.textContent = u.name||'사용자';
          profileEmail.textContent = u.email||'you@example.com';
        }else{
          loginBox.style.display='';
          profileBox.style.display='none';
        }
      }catch{
        loginBox.style.display='';
        profileBox.style.display='none';
      }
    }
    loginBtn.addEventListener('click', ()=>{
      const email = document.getElementById('email').value.trim();
      const pw = document.getElementById('pw').value.trim();
      if(!email || pw.length<4){ alert('이메일과 비밀번호(4자 이상)를 입력하세요.'); return; }
      localStorage.setItem(DEMO_KEY, JSON.stringify({email, name: email.split('@')[0]}));
      loadUser();
    });
    signupBtn.addEventListener('click', ()=>alert('회원가입은 실제 인증 연동 후 사용하세요.'));
    logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem(DEMO_KEY); loadUser(); });
    loadUser();
  </script>
</body>
</html>
