<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í•™ìŠµí•˜ê¸°</title>
  <style>
    :root{
      --blue:#1f6feb; --green:#18a058; --bg:#f7f8fa; --card:#fff; --text:#111; --muted:#667085; --red:#e5484d;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Pretendard,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:20;background:#0d47a1;color:#fff}
    header .row{display:flex;align-items:center;gap:12px;max-width:860px;margin:0 auto;padding:14px 12px}
    h1{font-size:20px;margin:0;font-weight:800}
    .wrap{max-width:860px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 0 rgba(0,0,0,.06);padding:16px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .btn{border:0;border-radius:12px;padding:11px 14px;background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--green);color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.red{background:var(--red);color:#fff}
    .muted{color:var(--muted)}
    .choice{border:1px solid #e5e7eb;border-radius:12px;padding:12px;cursor:pointer;background:#fff}
    .choice.correct{border-color:#22c55e; background:#ecfdf5}
    .choice.wrong{border-color:#ef4444; background:#fef2f2}
    .grid{display:grid;gap:10px}
    .progress{display:flex;align-items:center;gap:12px;color:var(--muted);font-weight:700}
    .chip{background:#eef2ff;color:#1e40af;border-radius:999px;padding:6px 10px;font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <button id="back" class="btn">â† ëŒì•„ê°€ê¸°</button>
      <h1>í•™ìŠµí•˜ê¸°</h1>
      <div style="margin-left:auto" id="dateBox" class="muted"></div>
    </div>
  </header>

  <div class="wrap">
    <!-- ëª¨ë“œ ì„ íƒ -->
    <div id="modeCard" class="card">
      <div class="toolbar">
        <div class="muted">í•™ìŠµ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <button class="btn blue" data-mode="mean">â‘  ë‹¨ì–´ â†’ ëœ»</button>
        <button class="btn blue" data-mode="cloze">â‘¡ ì˜ˆë¬¸ ë¹ˆì¹¸</button>
      </div>
    </div>

    <!-- í€´ì¦ˆ -->
    <div id="quizCard" class="card" style="display:none">
      <div class="progress">
        <span id="pIdx" class="chip">1 / 10</span>
        <span id="pScore">ì •ë‹µ 0</span>
        <span style="margin-left:auto" id="pMode" class="muted"></span>
      </div>
      <div id="qText" style="font-size:20px;font-weight:800;line-height:1.5;margin:10px 0 14px"></div>
      <div id="choices" class="grid"></div>
      <div class="toolbar" style="margin-top:14px">
        <button id="nextBtn" class="btn primary" disabled>ë‹¤ìŒ</button>
        <button id="finishBtn" class="btn red" style="margin-left:auto">ê·¸ë§Œí•˜ê¸°</button>
      </div>
    </div>

    <!-- ê²°ê³¼ -->
    <div id="resultCard" class="card" style="display:none">
      <h3 style="margin:0 0 6px">ê²°ê³¼</h3>
      <p id="rText" class="muted" style="margin:0 0 12px"></p>
      <div class="toolbar">
        <button id="retry" class="btn blue">ë‹¤ì‹œ í’€ê¸°</button>
        <button id="toIndex" class="btn">ë‹¨ì–´ ëª©ë¡ìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ìœ í‹¸ & ìƒíƒœ ======
    const qs = k => new URL(location.href).searchParams.get(k);
    const date = qs('date') || new Date().toISOString().slice(0,10);
    document.getElementById('dateBox').textContent = date;

    const state = {
      words: [],
      order: [],
      i: 0,
      score: 0,
      mode: 'mean', // 'mean' | 'cloze'
      answered: false
    };

    // ====== ë°ì´í„° ë¡œë“œ ======
    async function loadWords() {
      // ë‚ ì§œë³„ words.json ê²½ë¡œê°€ ë³„ë„ë¡œ ìˆìœ¼ë©´ ë°”ê¿”ì¤˜ë„ ë¨.
      // ì—¬ê¸°ì„œëŠ” ë£¨íŠ¸ words.json í•œ ê°œë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •.
      const res = await fetch('words.json', {cache:'no-store'});
      const all = await res.json();
      // words.json ì´ ë‚ ì§œë³„ ë¬¶ìŒì´ ì•„ë‹ˆë¼ "ì˜¤ëŠ˜ 10ê°œ" ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const arr = Array.isArray(all) ? all : (all[date] || all.words || []);
      state.words = arr.slice(0, 50); // ì•ˆì „
    }

    // ====== í™”ë©´ ì „í™˜ ======
    const modeCard = document.getElementById('modeCard');
    const quizCard = document.getElementById('quizCard');
    const resultCard = document.getElementById('resultCard');

    function show(el){
      modeCard.style.display = 'none';
      quizCard.style.display = 'none';
      resultCard.style.display = 'none';
      el.style.display = '';
    }

    // ====== í€´ì¦ˆ êµ¬ì„± ======
    const pIdx = document.getElementById('pIdx');
    const pScore = document.getElementById('pScore');
    const pMode = document.getElementById('pMode');
    const qText = document.getElementById('qText');
    const choicesWrap = document.getElementById('choices');
    const nextBtn = document.getElementById('nextBtn');

    function randInt(n){ return Math.floor(Math.random()*n); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=randInt(i+1); [a[i],a[j]]=[a[j],a[i]] } return a; }

    function start(mode){
      state.mode = mode;
      state.score = 0;
      state.i = 0;
      // ë¬¸ì œ ìˆœì„œ
      const N = Math.min(10, state.words.length);
      state.order = shuffle([...Array(state.words.length).keys()]).slice(0,N);
      pMode.textContent = (mode==='mean' ? 'ë‹¨ì–´ â†’ ëœ»' : 'ì˜ˆë¬¸ ë¹ˆì¹¸');
      show(quizCard);
      renderQuiz();
    }

    function makeChoices(correctIdx, field){
      const vals = new Set([ state.words[correctIdx][field] ]);
      while(vals.size < Math.min(4, state.words.length)){
        const j = randInt(state.words.length);
        vals.add(state.words[j][field]);
      }
      return shuffle([...vals]);
    }

    function renderQuiz(){
      nextBtn.disabled = true;
      state.answered = false;
      const realIdx = state.order[state.i];
      const w = state.words[realIdx];
      pIdx.textContent = `${state.i+1} / ${state.order.length}`;
      pScore.textContent = `ì •ë‹µ ${state.score}`;

      choicesWrap.innerHTML = '';
      if(state.mode==='mean'){
        qText.textContent = w.phrase;
        const choices = makeChoices(realIdx, 'meaning');
        choices.forEach(txt => addChoice(txt, txt===w.meaning));
      }else{
        const s = (w.example || '').replace(new RegExp(w.phrase,'ig'), '_____');
        qText.textContent = s || '(ì˜ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤)';
        const choices = makeChoices(realIdx, 'phrase');
        choices.forEach(txt => addChoice(txt, txt===w.phrase));
      }
    }

    function addChoice(text, isCorrect){
      const div = document.createElement('button');
      div.className = 'choice';
      div.textContent = text;
      div.onclick = ()=>{
        if(state.answered) return;
        state.answered = true;
        if(isCorrect){ div.classList.add('correct'); state.score++; }
        else{ div.classList.add('wrong'); }
        nextBtn.disabled = false;
      };
      choicesWrap.appendChild(div);
    }

    nextBtn.onclick = ()=>{
      if(state.i < state.order.length-1){ state.i++; renderQuiz(); }
      else { finish(); }
    };

    function finish(){
      show(resultCard);
      document.getElementById('rText').textContent =
        `ì´ ${state.order.length}ë¬¸ì œ ì¤‘ ${state.score}ê°œ ì •ë‹µ! í›Œë¥­í•´ìš” ğŸ‘`;
    }

    // ====== í•¸ë“¤ëŸ¬ ======
    document.getElementById('back').onclick = ()=> history.length>1 ? history.back() : location.href='index.html';
    document.getElementById('finishBtn').onclick = finish;
    document.getElementById('retry').onclick = ()=>{ show(modeCard); };
    document.getElementById('toIndex').onclick = ()=> location.href='index.html';

    // ëª¨ë“œ ë²„íŠ¼
    modeCard.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-mode]');
      if(!btn) return;
      if(!state.words.length){ alert('ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œâ€¦'); return; }
      start(btn.dataset.mode);
    });

    // ====== ì‹œì‘ ======
    (async()=>{
      await loadWords();
      show(modeCard);
    })();
  </script>
</body>
</html>
